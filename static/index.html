<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automated Training Evaluation & Performance Analytics System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #003366;
            --secondary-color: #0055a4;
            --accent-color: #e63946;
            --light-color: #f1faee;
            --dark-color: #1d3557;
        }

        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .navbar {
            background-color: var(--primary-color);
            box-shadow: 0 2px 4px rgba(0, 0, 0, .1);
        }

        .sidebar {
            background-color: white;
            min-height: calc(100vh - 56px);
            box-shadow: 2px 0 5px rgba(0, 0, 0, .05);
        }

        .card-custom {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: none;
        }

        .card-custom:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }

        .metric-card {
            border-left: 4px solid var(--secondary-color);
        }

        .metric-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--secondary-color);
        }

        .sidebar-link {
            color: #6c757d;
            text-decoration: none;
            padding: 10px 15px;
            display: block;
            border-radius: 5px;
            margin-bottom: 5px;
            transition: all 0.3s ease;
        }

        .sidebar-link:hover {
            background-color: #f8f9fa;
            color: var(--primary-color);
        }

        .sidebar-link.active {
            background-color: var(--primary-color);
            color: white;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 20px;
        }

        footer {
            background-color: var(--dark-color);
            color: white;
            padding: 20px 0;
            margin-top: 40px;
        }

        .bg-primary-light {
            background-color: rgba(0, 85, 164, 0.1);
        }
    </style>
</head>

<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-chart-line me-2"></i>Automated Training Evaluation & Performance Analytics System
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" data-section="dashboard-section">
                            <i class="fas fa-home me-1"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-section="upload-section">
                            <i class="fas fa-upload me-1"></i>Upload Tests
                        </a>
                    </li>

                    <li class="nav-item">
                        <a class="nav-link" href="#" data-section="analytics-section">
                            <i class="fas fa-chart-bar me-1"></i>Analytics
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-section="reports-section">
                            <i class="fas fa-file-alt me-1"></i>Reports
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-section="settings-section">
                            <i class="fas fa-cog me-1"></i>Settings
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-lg-2 col-md-3 sidebar d-none d-md-block">
                <div class="p-3">
                    <h5 class="text-muted mb-3">Navigation</h5>
                    <a href="#" class="sidebar-link active" data-section="dashboard-section">
                        <i class="fas fa-tachometer-alt me-2"></i>Dashboard
                    </a>
                    <a href="#" class="sidebar-link" data-section="upload-section">
                        <i class="fas fa-upload me-2"></i>Upload Tests
                    </a>

                    <a href="#" class="sidebar-link" data-section="analytics-section">
                        <i class="fas fa-chart-bar me-2"></i>Performance Analytics
                    </a>
                    <a href="#" class="sidebar-link" data-section="reports-section">
                        <i class="fas fa-file-alt me-2"></i>Generate Reports
                    </a>
                    <a href="#" class="sidebar-link" data-section="settings-section">
                        <i class="fas fa-cog me-2"></i>System Settings
                    </a>
                    <a href="#" class="sidebar-link" data-section="onedrive-section">
                        <i class="fab fa-microsoft me-2"></i>OneDrive Sync
                    </a>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-lg-10 col-md-9 p-4">
                <!-- Dashboard Section -->
                <div id="dashboard-section" class="section active">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h2 class="mb-0">Dashboard Overview</h2>
                            <small class="text-muted" id="last-updated">Last updated: <span
                                    id="update-timestamp">Never</span></small>
                        </div>
                        <button class="btn btn-primary" id="refresh-dashboard">
                            <i class="fas fa-sync-alt me-1"></i>Refresh Data
                        </button>
                    </div>
                    <!-- Key Metrics -->
                    <div class="row mb-4">
                        <div class="col-md-3 mb-3">
                            <div class="card card-custom metric-card">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h6 class="text-muted">Total Tests</h6>
                                            <h3 id="total-tests-count">0</h3>
                                        </div>
                                        <div class="bg-primary-light p-3 rounded">
                                            <i class="fas fa-file-alt text-primary fs-4"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card card-custom metric-card">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h6 class="text-muted">Avg. Score</h6>
                                            <h3 id="avg-score-dashboard">0%</h3>
                                        </div>
                                        <div class="bg-primary-light p-3 rounded">
                                            <i class="fas fa-chart-line text-primary fs-4"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card card-custom metric-card">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h6 class="text-muted">Pass Rate</h6>
                                            <h3 id="pass-rate-dashboard">0%</h3>
                                        </div>
                                        <div class="bg-primary-light p-3 rounded">
                                            <i class="fas fa-check-circle text-primary fs-4"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card card-custom metric-card">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h6 class="text-muted">Total Employees</h6>
                                            <h3 id="total-candidates-dashboard">0</h3>
                                        </div>
                                        <div class="bg-primary-light p-3 rounded">
                                            <i class="fas fa-users text-primary fs-4"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>

                    <!-- Historical Analytics -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card card-custom">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0"><i class="fas fa-history me-2"></i>Historical Analytics</h5>
                                </div>
                                <div class="card-body">
                                    <ul class="nav nav-tabs" id="historicalAnalyticsTabs" role="tablist">
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link active" id="filtered-analytics-tab"
                                                data-bs-toggle="tab" data-bs-target="#filtered-analytics" type="button"
                                                role="tab">Filtered Analytics</button>
                                        </li>
                                    </ul>
                                    <div class="tab-content" id="historicalAnalyticsTabContent">
                                        <!-- Filtered Analytics Tab -->
                                        <div class="tab-pane fade show active" id="filtered-analytics" role="tabpanel">
                                            <div class="row mt-3">
                                                <div class="col-md-3">
                                                    <label for="filtered-training-name" class="form-label">Training
                                                        Name</label>
                                                    <select class="form-select" id="filtered-training-name">
                                                        <option value="">All Trainings</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-3">
                                                    <label for="filtered-faculty-name" class="form-label">Faculty
                                                        Name</label>
                                                    <select class="form-select" id="filtered-faculty-name">
                                                        <option value="">All Faculties</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-3">
                                                    <label for="filtered-ticket-no" class="form-label">P.no/Ticket
                                                        no.</label>
                                                    <input type="text" class="form-control" id="filtered-ticket-no"
                                                        placeholder="Enter P.no or Ticket no.">
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="row">
                                                        <div class="col-md-6">
                                                            <label for="filtered-start-date" class="form-label">Start
                                                                Date</label>
                                                            <input type="date" class="form-control"
                                                                id="filtered-start-date">
                                                        </div>
                                                        <div class="col-md-6">
                                                            <label for="filtered-end-date" class="form-label">End
                                                                Date</label>
                                                            <input type="date" class="form-control"
                                                                id="filtered-end-date">
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="row mt-3">
                                                <div class="col-md-12">
                                                    <button class="btn btn-primary" id="load-filtered-analytics">
                                                        <i class="fas fa-filter me-1"></i>Apply Filters
                                                    </button>
                                                    <button class="btn btn-outline-secondary ms-2" id="clear-filters">
                                                        <i class="fas fa-times me-1"></i>Clear Filters
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Historical Analytics Results -->
                    <div class="row mb-4" id="historical-analytics-results" style="display: none;">
                        <div class="col-12">
                            <div class="card card-custom">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0" id="historical-results-title">Historical Analytics Results</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <h6>Overview</h6>
                                            <ul>
                                                <li><strong>Training Name:</strong> <span
                                                        id="historical-training-name">-</span></li>
                                                <li><strong>Total Tests:</strong> <span
                                                        id="historical-total-tests">0</span></li>
                                                <li><strong>Total Candidates:</strong> <span
                                                        id="historical-total-candidates">0</span></li>
                                            </ul>
                                        </div>
                                        <div class="col-md-6">
                                            <h6>Performance Metrics</h6>
                                            <ul>
                                                <li><strong>Average Score:</strong> <span
                                                        id="historical-avg-score">0%</span></li>
                                                <li><strong>Pass Rate:</strong> <span
                                                        id="historical-pass-rate">0%</span></li>
                                                <li><strong>Highest Score:</strong> <span
                                                        id="historical-highest-score">0%</span></li>
                                            </ul>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-12">
                                            <h6>Performance Distribution</h6>
                                            <div class="progress-stacked" style="height: 20px;">
                                                <div class="progress" role="progressbar" aria-label="Excellent"
                                                    aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"
                                                    style="width: 0%" id="historical-excellent-progress">
                                                    <div class="progress-bar bg-success"></div>
                                                </div>
                                                <div class="progress" role="progressbar" aria-label="Good"
                                                    aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"
                                                    style="width: 0%" id="historical-good-progress">
                                                    <div class="progress-bar bg-info"></div>
                                                </div>
                                                <div class="progress" role="progressbar" aria-label="Average"
                                                    aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"
                                                    style="width: 0%" id="historical-average-progress">
                                                    <div class="progress-bar bg-warning"></div>
                                                </div>
                                                <div class="progress" role="progressbar" aria-label="Needs Improvement"
                                                    aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"
                                                    style="width: 0%" id="historical-poor-progress">
                                                    <div class="progress-bar bg-danger"></div>
                                                </div>
                                            </div>
                                            <div class="row mt-2 text-center small">
                                                <div class="col-3 border-end">
                                                    <span class="badge bg-success mb-1">Excellent (90%+)</span><br>
                                                    <span id="historical-excellent-count" class="fw-bold">0
                                                        employees</span>
                                                </div>
                                                <div class="col-3 border-end">
                                                    <span class="badge bg-info mb-1">Good (70-89%)</span><br>
                                                    <span id="historical-good-count" class="fw-bold">0 employees</span>
                                                </div>
                                                <div class="col-3 border-end">
                                                    <span class="badge bg-warning text-dark mb-1">Average
                                                        (50-69%)</span><br>
                                                    <span id="historical-average-count" class="fw-bold">0
                                                        employees</span>
                                                </div>
                                                <div class="col-3">
                                                    <span class="badge bg-danger mb-1">Poor (<50%)< /span><br>
                                                            <span id="historical-poor-count" class="fw-bold">0
                                                                employees</span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row mt-4">
                                            <div class="col-md-12">
                                                <h6>Test History</h6>
                                                <div class="table-responsive">
                                                    <table class="table table-striped">
                                                        <thead>
                                                            <tr>
                                                                <th>Test ID</th>
                                                                <th>Test Type</th>
                                                                <th>Date Uploaded</th>
                                                                <th>Candidates</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody id="historical-test-history">
                                                            <tr>
                                                                <td colspan="4" class="text-center">No data available
                                                                </td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Recent Excel Analysis -->
                        <div class="row mb-4" id="recent-analysis-section" style="display: none;">
                            <div class="col-12">
                                <div class="card card-custom">
                                    <div class="card-header bg-success text-white">
                                        <h5 class="mb-0">Recent Excel Sheet Analysis</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <h6>File Information</h6>
                                                <ul id="recent-file-info">
                                                    <li><strong>File Name:</strong> <span id="recent-file-name">-</span>
                                                    </li>
                                                    <li><strong>Training Name:</strong> <span
                                                            id="recent-training-name">-</span></li>
                                                    <li><strong>Test Type:</strong> <span id="recent-test-type">-</span>
                                                    </li>
                                                    <li><strong>Upload Date:</strong> <span
                                                            id="recent-upload-date">-</span></li>
                                                </ul>
                                            </div>
                                            <div class="col-md-6">
                                                <h6>Performance Summary</h6>
                                                <ul id="recent-performance-summary">
                                                    <li><strong>Total Employees:</strong> <span
                                                            id="recent-total-candidates">0</span></li>
                                                    <li><strong>Average Score:</strong> <span
                                                            id="recent-avg-score">0%</span></li>
                                                    <li><strong>Pass Rate:</strong> <span
                                                            id="recent-pass-rate">0%</span></li>
                                                    <li><strong>Highest Score:</strong> <span
                                                            id="recent-highest-score">0%</span></li>
                                                </ul>
                                            </div>
                                        </div>

                                        <div class="row mt-3">
                                            <div class="col-md-12">
                                                <h6>Performance Distribution</h6>
                                                <div class="progress-stacked" style="height: 20px;">
                                                    <div class="progress" role="progressbar" aria-label="Excellent"
                                                        aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"
                                                        style="width: 0%" id="excellent-progress-dashboard">
                                                        <div class="progress-bar bg-success"></div>
                                                    </div>
                                                    <div class="progress" role="progressbar" aria-label="Good"
                                                        aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"
                                                        style="width: 0%" id="good-progress-dashboard">
                                                        <div class="progress-bar bg-info"></div>
                                                    </div>
                                                    <div class="progress" role="progressbar" aria-label="Average"
                                                        aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"
                                                        style="width: 0%" id="average-progress-dashboard">
                                                        <div class="progress-bar bg-warning"></div>
                                                    </div>
                                                    <div class="progress" role="progressbar"
                                                        aria-label="Needs Improvement" aria-valuenow="0"
                                                        aria-valuemin="0" aria-valuemax="100" style="width: 0%"
                                                        id="poor-progress-dashboard">
                                                        <div class="progress-bar bg-danger"></div>
                                                    </div>
                                                </div>
                                                <div class="row mt-2 text-center small">
                                                    <div class="col-3 border-end">
                                                        <span class="badge bg-success mb-1">Excellent (90%+)</span><br>
                                                        <span id="excellent-count-dashboard" class="fw-bold">0
                                                            employees</span>
                                                    </div>
                                                    <div class="col-3 border-end">
                                                        <span class="badge bg-info mb-1">Good (70-89%)</span><br>
                                                        <span id="good-count-dashboard" class="fw-bold">0
                                                            employees</span>
                                                    </div>
                                                    <div class="col-3 border-end">
                                                        <span class="badge bg-warning text-dark mb-1">Average
                                                            (50-69%)</span><br>
                                                        <span id="average-count-dashboard" class="fw-bold">0
                                                            employees</span>
                                                    </div>
                                                    <div class="col-3">
                                                        <span class="badge bg-danger mb-1">Poor (<50%)< /span><br>
                                                                <span id="poor-count-dashboard" class="fw-bold">0
                                                                    employees</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row mt-3">
                                            <div class="col-md-12">
                                                <div class="alert alert-info">
                                                    <h6><i class="fas fa-info-circle me-2"></i>Analysis Notes</h6>
                                                    <ul class="mb-0">
                                                        <li>Passing score for all tests is 35%</li>
                                                        <li>Performance distribution is estimated based on pass rate
                                                        </li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Charts Row 1 -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card card-custom h-100">
                                    <div class="card-header bg-primary text-white">
                                        <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Performance Trends
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="chart-container" style="height: 300px;">
                                            <canvas id="performanceChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card card-custom h-100">
                                    <div class="card-header bg-success text-white">
                                        <h5 class="mb-0"><i class="fas fa-exchange-alt me-2"></i>Pre vs Post</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="chart-container" style="height: 300px;">
                                            <canvas id="prePostComparisonChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card card-custom h-100">
                                    <div class="card-header bg-info text-white">
                                        <h5 class="mb-0"><i class="fas fa-percentage me-2"></i>Pass/Fail</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="chart-container" style="height: 300px;">
                                            <canvas id="passFailChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Charts Row 2 -->
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="card card-custom h-100">
                                    <div class="card-header bg-info text-white">
                                        <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Score Distribution
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="chart-container" style="height: 300px;">
                                            <canvas id="scoreDistributionChartDashboard"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card card-custom h-100">
                                    <div class="card-header bg-warning text-dark">
                                        <h5 class="mb-0"><i class="fas fa-crown me-2"></i>Top 10 Performers</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="chart-container" style="height: 300px;">
                                            <canvas id="topPerformersChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card card-custom h-100">
                                    <div class="card-header bg-danger text-white">
                                        <h5 class="mb-0"><i class="fas fa-arrow-down me-2"></i>Bottom 10 Performers
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="chart-container" style="height: 300px;">
                                            <canvas id="bottomPerformersChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>


                    <!-- Recent Activity -->
                    <div class="card card-custom">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0">Recent Activity</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Test Name</th>
                                            <th>Date</th>
                                            <th>Type</th>
                                            <th>Avg. Score</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recent-activity-body">
                                        <tr>
                                            <td colspan="5" class="text-center">Loading recent activity...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Test-Specific Analytics -->
                    <div class="row mb-4" id="test-analytics-section">
                        <div class="col-12">
                            <div class="card card-custom">
                                <div
                                    class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Test-Specific
                                        Analytics</h5>
                                    <button class="btn btn-sm btn-light" id="refresh-test-analytics">
                                        <i class="fas fa-sync-alt me-1"></i>Refresh
                                    </button>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-striped" id="test-analytics-table">
                                            <thead>
                                                <tr>
                                                    <th>Test ID</th>
                                                    <th>Training Name</th>
                                                    <th>Test Type</th>
                                                    <th>Date Uploaded</th>
                                                    <th>Total Candidates</th>
                                                    <th>Avg. Score</th>
                                                    <th>Pass Rate</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="test-analytics-body">
                                                <tr>
                                                    <td colspan="8" class="text-center">Loading test
                                                        analytics...</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Upload Section -->
                <div id="upload-section" class="section">
                    <h2 class="mb-4">Upload Test Papers</h2>
                    <div class="card card-custom">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">Upload Test Files</h5>
                        </div>
                        <div class="card-body">
                            <form id="upload-form">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="test-type" class="form-label">Test Type</label>
                                        <select class="form-select" id="test-type" required>
                                            <option value="">Select test type</option>
                                            <option value="Pre-Test">Pre-Test</option>
                                            <option value="Post-Test">Post-Test</option>
                                            <option value="Mid-Term">Mid-Term</option>
                                            <option value="Final">Final</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="training-date" class="form-label">Training Date</label>
                                        <input type="date" class="form-control" id="training-date" required>
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-md-12">
                                        <label for="training-selection" class="form-label">Training
                                            Selection</label>
                                        <div class="input-group">
                                            <select class="form-select" id="training-selection">
                                                <option value="">Select existing training or add new</option>
                                                <option value="Machine guarding">Machine guarding</option>
                                                <option value="Action employee can take">Action employee can
                                                    take</option>
                                                <option value="Orientation to Automobile Electrical and electronics">
                                                    Orientation to Automobile Electrical and electronics
                                                </option>
                                                <option value="Loto">Loto</option>
                                                <option value="Advance Excel">Advance Excel</option>
                                                <option value="Ppe">Ppe</option>
                                                <option value="Hira">Hira</option>
                                                <option value="safety Standards Rules & Regulations">safety
                                                    Standards Rules & Regulations</option>
                                            </select>
                                            <button class="btn btn-outline-secondary" type="button"
                                                id="add-new-training-btn">
                                                <i class="fas fa-plus"></i> Add New
                                            </button>
                                        </div>
                                        <div id="new-training-input" style="display: none; margin-top: 10px;">
                                            <input type="text" class="form-control" id="new-training-name"
                                                placeholder="Enter new training name">
                                        </div>
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-md-12">
                                        <label for="faculty-name" class="form-label">Faculty/Trainer
                                            Name</label>
                                        <div class="input-group">
                                            <select class="form-select" id="faculty-name">
                                                <option value="">Select faculty or add new</option>
                                            </select>
                                            <button class="btn btn-outline-secondary" type="button"
                                                id="add-new-faculty-btn">
                                                <i class="fas fa-plus"></i> Add New
                                            </button>
                                        </div>
                                        <div id="new-faculty-input" style="display: none; margin-top: 10px;">
                                            <input type="text" class="form-control" id="new-faculty-name"
                                                placeholder="Enter new faculty name">
                                        </div>
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="test-files" class="form-label">Select Test Files</label>
                                        <input class="form-control" type="file" id="test-files" multiple
                                            accept=".pdf,.jpg,.jpeg,.png,.xlsx,.xls">
                                        <div class="form-text">Supported formats: PDF, JPG, PNG, XLSX, XLS</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="ticket-no" class="form-label">P.no/Ticket no.
                                            (Optional)</label>
                                        <input type="text" class="form-control" id="ticket-no"
                                            placeholder="Enter P.no or Ticket no.">
                                    </div>
                                </div>

                                <!-- Simultaneous Upload Section -->
                                <div class="card card-custom mt-4">
                                    <div class="card-header bg-success text-white">
                                        <h5 class="mb-0"><i class="fas fa-sync-alt me-2"></i>Simultaneous
                                            Pre-Test & Post-Test Upload</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="pre-test-files" class="form-label">Pre-Test
                                                    Files</label>
                                                <input class="form-control" type="file" id="pre-test-files" multiple
                                                    accept=".pdf,.jpg,.jpeg,.png,.xlsx,.xls">
                                                <div class="form-text">Select one or more pre-test files</div>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="post-test-files" class="form-label">Post-Test
                                                    Files</label>
                                                <input class="form-control" type="file" id="post-test-files" multiple
                                                    accept=".pdf,.jpg,.jpeg,.png,.xlsx,.xls">
                                                <div class="form-text">Select one or more post-test files</div>
                                            </div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="simultaneous-training-name" class="form-label">Training
                                                    Name</label>
                                                <select class="form-select" id="simultaneous-training-name">
                                                    <option value="">Select existing training or add new
                                                    </option>
                                                    <option value="Machine guarding">Machine guarding</option>
                                                    <option value="Action employee can take">Action employee can
                                                        take</option>
                                                    <option
                                                        value="Orientation to Automobile Electrical and electronics">
                                                        Orientation to Automobile Electrical and electronics
                                                    </option>
                                                    <option value="Loto">Loto</option>
                                                    <option value="Advance Excel">Advance Excel</option>
                                                    <option value="Ppe">Ppe</option>
                                                    <option value="Hira">Hira</option>
                                                    <option value="safety Standards Rules & Regulations">safety
                                                        Standards Rules & Regulations</option>
                                                </select>
                                                <div class="input-group mt-2">
                                                    <input type="text" class="form-control"
                                                        id="new-simultaneous-training-name"
                                                        placeholder="Or enter new training name">
                                                    <button class="btn btn-outline-primary" type="button"
                                                        id="add-simultaneous-training-btn">
                                                        Add Training
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="simultaneous-faculty-name"
                                                    class="form-label">Faculty/Trainer
                                                    Name</label>
                                                <div class="input-group">
                                                    <select class="form-select" id="simultaneous-faculty-name">
                                                        <option value="">Select faculty or add new</option>
                                                    </select>
                                                    <button class="btn btn-outline-secondary" type="button"
                                                        id="add-new-simultaneous-faculty-btn">
                                                        <i class="fas fa-plus"></i> Add New
                                                    </button>
                                                </div>
                                                <div id="new-simultaneous-faculty-input"
                                                    style="display: none; margin-top: 10px;">
                                                    <input type="text" class="form-control"
                                                        id="new-simultaneous-faculty-name"
                                                        placeholder="Enter new faculty name">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-md-4">
                                                <label for="pre-test-date" class="form-label">Pre-Test
                                                    Date</label>
                                                <input type="date" class="form-control" id="pre-test-date">
                                            </div>
                                            <div class="col-md-4">
                                                <label for="post-test-date" class="form-label">Post-Test
                                                    Date</label>
                                                <input type="date" class="form-control" id="post-test-date">
                                            </div>
                                            <div class="col-md-4">
                                                <label for="simultaneous-ticket-no" class="form-label">Batch
                                                    Tracking No. (Optional)</label>
                                                <input type="text" class="form-control" id="simultaneous-ticket-no"
                                                    placeholder="Enter Batch Tracking Number">
                                                <div class="form-text">This number will be associated with both
                                                    Pre-Test and Post-Test uploads for easy tracking</div>
                                            </div>
                                        </div>
                                        <button type="button" class="btn btn-success" id="upload-simultaneous-btn">
                                            <i class="fas fa-upload me-1"></i>Upload Both Tests
                                        </button>
                                    </div>
                                </div>

                                <button type="submit" class="btn btn-primary" id="upload-btn">
                                    <i class="fas fa-upload me-1"></i>Upload Files
                                </button>
                            </form>

                            <div id="upload-result" class="mt-3" style="display: none;">
                                <div class="alert alert-success" role="alert">
                                    <h5>Upload Successful!</h5>
                                    <p id="upload-message"></p>
                                    <p>Uploaded files: <span id="uploaded-files"></span></p>
                                </div>
                            </div>

                            <!-- Excel Analysis Section -->
                            <div id="excel-analysis" class="mt-4" style="display: none;">
                                <h5>Excel File Analysis</h5>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="card card-custom">
                                            <div class="card-header bg-info text-white">
                                                <h6 class="mb-0">File Information</h6>
                                            </div>
                                            <div class="card-body">
                                                <ul id="file-info"></ul>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card card-custom">
                                            <div class="card-header bg-info text-white">
                                                <h6 class="mb-0">Data Summary</h6>
                                            </div>
                                            <div class="card-body">
                                                <ul id="data-summary"></ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="card card-custom mt-3">
                                    <div class="card-header bg-success text-white">
                                        <h6 class="mb-0">Employee Preview</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="table-responsive">
                                            <table class="table table-striped">
                                                <thead id="candidate-table-head">
                                                </thead>
                                                <tbody id="candidate-table-body">
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>

                                <div class="row mt-3" id="subject-performance">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>



                <!-- Analytics Section -->
                <div id="analytics-section" class="section">
                    <h2 class="mb-4">Performance Analytics</h2>

                    <!-- Training Selection -->
                    <div class="card card-custom mb-4">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Select Training for Analysis</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <label for="analytics-test-id" class="form-label">Select Test for Batch
                                        Analytics</label>
                                    <select class="form-select" id="analytics-test-id">
                                        <option value="">Loading tests...</option>
                                    </select>
                                </div>
                                <div class="col-md-4 d-flex align-items-end">
                                    <button class="btn btn-primary w-100" id="refresh-analytics">
                                        <i class="fas fa-sync-alt me-1"></i>Refresh Data
                                    </button>
                                </div>
                            </div>

                            <div class="row mt-3">
                                <div class="col-md-8">
                                    <label for="candidate-id" class="form-label">Enter Employee ID for
                                        Individual Analytics</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="candidate-id"
                                            placeholder="Enter employee ID (e.g., T00123)">
                                        <button class="btn btn-outline-secondary" type="button"
                                            id="get-candidate-analytics">
                                            <i class="fas fa-search"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-4 d-flex align-items-end">
                                    <button class="btn btn-info w-100" id="compare-tests-btn">
                                        <i class="fas fa-exchange-alt me-1"></i>Compare Tests
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Total Training Analysis -->
                    <div id="total-training-analysis" class="card card-custom mb-4" style="display: none;">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Total Training Analysis</h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <h6>Training Details</h6>
                                    <p><strong>Name:</strong> <span id="training-name">-</span></p>
                                    <p><strong>Type:</strong> <span id="training-type">-</span></p>
                                    <p><strong>Date Conducted:</strong> <span id="training-date">-</span></p>
                                </div>
                                <div class="col-md-6">
                                    <h6>Overall Performance</h6>
                                    <p><strong>Total Employees:</strong> <span id="total-candidates">0</span>
                                    </p>
                                    <p><strong>Average Score:</strong> <span id="overall-average">0</span>%</p>
                                    <p><strong>Pass Rate:</strong> <span id="overall-pass-rate">0</span>%</p>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-12">
                                    <h6>Performance Distribution</h6>
                                    <div class="progress-stacked" style="height: 20px;">
                                        <div class="progress" role="progressbar" aria-label="Excellent"
                                            aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%"
                                            id="excellent-progress">
                                            <div class="progress-bar bg-success"></div>
                                        </div>
                                        <div class="progress" role="progressbar" aria-label="Good" aria-valuenow="0"
                                            aria-valuemin="0" aria-valuemax="100" style="width: 0%" id="good-progress">
                                            <div class="progress-bar bg-info"></div>
                                        </div>
                                        <div class="progress" role="progressbar" aria-label="Average" aria-valuenow="0"
                                            aria-valuemin="0" aria-valuemax="100" style="width: 0%"
                                            id="average-progress">
                                            <div class="progress-bar bg-warning"></div>
                                        </div>
                                        <div class="progress" role="progressbar" aria-label="Needs Improvement"
                                            aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%"
                                            id="poor-progress">
                                            <div class="progress-bar bg-danger"></div>
                                        </div>
                                    </div>
                                    <div class="row mt-2 text-center small">
                                        <div class="col-3 border-end">
                                            <span class="badge bg-success mb-1">Excellent (90%+)</span><br>
                                            <span id="excellent-count" class="fw-bold">0 employees</span>
                                        </div>
                                        <div class="col-3 border-end">
                                            <span class="badge bg-info mb-1">Good (70-89%)</span><br>
                                            <span id="good-count" class="fw-bold">0 employees</span>
                                        </div>
                                        <div class="col-3 border-end">
                                            <span class="badge bg-warning text-dark mb-1">Average (50-69%)</span><br>
                                            <span id="average-count" class="fw-bold">0 employees</span>
                                        </div>
                                        <div class="col-3">
                                            <span class="badge bg-danger mb-1">Poor (<50%)< /span><br>
                                                    <span id="poor-count" class="fw-bold">0 employees</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row mt-4">
                                <div class="col-md-6">
                                    <h6>Top Performers</h6>
                                    <ul class="list-group" id="top-performers-list">
                                        <li class="list-group-item">No data available</li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h6>Areas for Improvement</h6>
                                    <ul class="list-group" id="improvement-areas-list">
                                        <li class="list-group-item">No data available</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Batch Analytics Results -->
                    <div id="batch-analytics-result" class="card card-custom mb-4" style="display: none;">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0"><i class="fas fa-users me-2"></i>Batch Analytics Results</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3 mb-3">
                                    <div class="card card-custom h-100">
                                        <div class="card-body text-center">
                                            <h6>Average Score</h6>
                                            <h3 id="avg-score">0</h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <div class="card card-custom h-100">
                                        <div class="card-body text-center">
                                            <h6>Highest Score</h6>
                                            <h3 id="highest-score">0</h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <div class="card card-custom h-100">
                                        <div class="card-body text-center">
                                            <h6>Pass Rate</h6>
                                            <h3 id="pass-rate">0%</h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <div class="card card-custom h-100">
                                        <div class="card-body text-center">
                                            <h6>Total Employees</h6>
                                            <h3 id="total-candidates-batch">0</h3>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row mt-3">
                                <div class="col-md-12">
                                    <canvas id="score-distribution-chart" height="100"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Employee Analytics Results -->
                    <div id="candidate-analytics-result" class="card card-custom" style="display: none;">
                        <div class="card-header bg-warning text-dark">
                            <h5 class="mb-0"><i class="fas fa-user-graduate me-2"></i>Employee Analytics
                                Results</h5>
                        </div>
                        <div class="card-body">
                            <h6>Employee ID: <span id="candidate-id-display"></span></h6>
                            <p>Improvement Percentage: <strong id="improvement-percentage">0%</strong></p>

                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <h6>Performance Summary</h6>
                                    <div class="table-responsive">
                                        <table class="table table-striped">
                                            <thead>
                                                <tr>
                                                    <th>Test</th>
                                                    <th>Score</th>
                                                    <th>Status</th>
                                                </tr>
                                            </thead>
                                            <tbody id="performance-summary-table">
                                                <tr>
                                                    <td colspan="3">No data available</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6>Progress Chart</h6>
                                    <canvas id="candidate-progress-chart" height="150"></canvas>
                                </div>
                            </div>

                            <div id="performance-history">
                                <h6 class="mt-4">Performance History</h6>
                                <ul id="performance-list" class="list-group">
                                    <li class="list-group-item">No data available</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Reports Section -->
                <div id="reports-section" class="section">
                    <h2 class="mb-4">Generate Reports</h2>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card card-custom">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0">Batch Reports</h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="report-test-id" class="form-label">Select Test</label>
                                        <select class="form-select" id="report-test-id">
                                            <option value="">Loading tests...</option>
                                        </select>
                                    </div>

                                    <div class="d-grid gap-2">
                                        <button class="btn btn-primary" id="generate-batch-report">
                                            <i class="fas fa-file-pdf me-1"></i>Generate PDF Report
                                        </button>
                                        <button class="btn btn-success" id="download-batch-excel">
                                            <i class="fas fa-file-excel me-1"></i>Download Excel Report
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="card card-custom">
                                <div class="card-header bg-info text-white">
                                    <h5 class="mb-0">Individual Reports</h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="individual-candidate-id" class="form-label">Employee
                                            ID</label>
                                        <input type="text" class="form-control" id="individual-candidate-id"
                                            placeholder="Enter employee ID">
                                    </div>

                                    <div class="d-grid gap-2">
                                        <button class="btn btn-primary" id="generate-individual-report">
                                            <i class="fas fa-file-pdf me-1"></i>Generate PDF Report
                                        </button>
                                        <button class="btn btn-success" id="download-individual-excel">
                                            <i class="fas fa-file-excel me-1"></i>Download Excel Report
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Settings Section -->
                <div id="settings-section" class="section">
                    <h2 class="mb-4">System Settings</h2>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card card-custom">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0">System Configuration</h5>
                                </div>
                                <div class="card-body">
                                    <form>
                                        <div class="mb-3">
                                            <label class="form-label">Passing Score Threshold</label>
                                            <input type="number" class="form-control" value="35">
                                            <div class="form-text">Minimum percentage to pass a test</div>
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label">Auto-Evaluation</label>
                                            <select class="form-select">
                                                <option>Enabled</option>
                                                <option>Disabled</option>
                                            </select>
                                            <div class="form-text">Automatically evaluate uploaded tests
                                            </div>
                                        </div>

                                        <div class="mb-3 form-check">
                                            <input type="checkbox" class="form-check-input" id="notifications">
                                            <label class="form-check-label" for="notifications">Enable Email
                                                Notifications</label>
                                        </div>

                                        <button type="submit" class="btn btn-primary">Save Settings</button>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="card card-custom">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0">User Management</h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">Add New User</label>
                                        <input type="text" class="form-control" placeholder="Full Name">
                                    </div>

                                    <div class="mb-3">
                                        <input type="email" class="form-control" placeholder="Email Address">
                                    </div>

                                    <div class="mb-3">
                                        <select class="form-select">
                                            <option>Administrator</option>
                                            <option>Trainer</option>
                                            <option>Supervisor</option>
                                        </select>
                                    </div>

                                    <button class="btn btn-success">Add User</button>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="card card-custom">
                                <div class="card-header bg-danger text-white">
                                    <h5 class="mb-0">Data Management</h5>
                                </div>
                                <div class="card-body">
                                    <div class="alert alert-warning">
                                        <h6><i class="fas fa-exclamation-triangle me-2"></i>Caution</h6>
                                        <p>Deleting data is irreversible. All uploaded Excel sheets and
                                            processed results will be permanently removed.</p>
                                    </div>

                                    <button class="btn btn-danger" id="delete-all-data">
                                        <i class="fas fa-trash-alt me-1"></i>Delete All Excel Data
                                    </button>

                                    <div id="delete-result" class="mt-3" style="display: none;">
                                        <div class="alert" role="alert">
                                            <p id="delete-message"></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- OneDrive Section -->
                <div id="onedrive-section" class="section">
                    <h2 class="mb-4">OneDrive Integration</h2>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card card-custom">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0">Attendance Sync</h5>
                                </div>
                                <div class="card-body">
                                    <p>Sync attendance data from OneDrive</p>
                                    <button class="btn btn-primary" id="sync-attendance">
                                        <i class="fab fa-microsoft me-1"></i>Sync Attendance
                                    </button>

                                    <div id="attendance-sync-result" class="mt-3" style="display: none;">
                                        <div class="alert alert-success">
                                            <p>Attendance sync completed successfully!</p>
                                            <p>Records synced: <span id="attendance-records-count">0</span>
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="card card-custom">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0">Training Documents</h5>
                                </div>
                                <div class="card-body">
                                    <p>Sync training documents from OneDrive</p>
                                    <button class="btn btn-success" id="sync-documents">
                                        <i class="fab fa-microsoft me-1"></i>Sync Documents
                                    </button>

                                    <div id="documents-sync-result" class="mt-3" style="display: none;">
                                        <div class="alert alert-success">
                                            <p>Documents sync completed successfully!</p>
                                            <p>Documents synced: <span id="documents-count">0</span></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Global variables
        const API_BASE_URL = 'http://localhost:5000/api';
        let performanceChart, passFailChart, scoreDistributionChartDashboard, topPerformersChart, bottomPerformersChart, prePostComparisonChart;

        // Initialize charts
        function initializeCharts() {
            // Performance Chart (Trends)
            const perfCtx = document.getElementById('performanceChart').getContext('2d');
            performanceChart = new Chart(perfCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Pre-Test Avg',
                        data: [],
                        borderColor: '#0055a4',
                        backgroundColor: 'rgba(0, 85, 164, 0.1)',
                        tension: 0.3,
                        fill: true
                    }, {
                        label: 'Post-Test Avg',
                        data: [],
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' }
                    },
                    scales: {
                        y: { beginAtZero: true, max: 100 }
                    }
                }
            });

            // Pass/Fail Ratio Chart
            const pfCtx = document.getElementById('passFailChart').getContext('2d');
            passFailChart = new Chart(pfCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Pass', 'Fail'],
                    datasets: [{
                        data: [0, 0],
                        backgroundColor: ['#28a745', '#dc3545'],
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });

            // Score Distribution Chart
            const sdCtx = document.getElementById('scoreDistributionChartDashboard').getContext('2d');
            scoreDistributionChartDashboard = new Chart(sdCtx, {
                type: 'bar',
                data: {
                    labels: ['Excellent (90)', 'Good (70-89)', 'Average (50-69)', 'Poor (<50)'],
                    datasets: [{
                        label: 'Count',
                        data: [0, 0, 0, 0],
                        backgroundColor: ['#003366', '#0055a4', '#ffc107', '#dc3545']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });

            // Top Performers Chart
            const tpCtx = document.getElementById('topPerformersChart').getContext('2d');
            topPerformersChart = new Chart(tpCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Best Score (%)',
                        data: [],
                        backgroundColor: '#0055a4'
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: { beginAtZero: true, max: 100 }
                    }
                }
            });

            // Bottom Performers Chart
            const bpCtx = document.getElementById('bottomPerformersChart').getContext('2d');
            bottomPerformersChart = new Chart(bpCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Best Score (%)',
                        data: [],
                        backgroundColor: '#dc3545'
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: { beginAtZero: true, max: 100 }
                    }
                }
            });

            // Pre vs Post Comparison Chart
            const prePostComparisonCtx = document.getElementById('prePostComparisonChart').getContext('2d');
            prePostComparisonChart = new Chart(prePostComparisonCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Pre-Test',
                            data: [],
                            backgroundColor: '#0d6efd'
                        },
                        {
                            label: 'Post-Test',
                            data: [],
                            backgroundColor: '#198754'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, max: 100 }
                    }
                }
            });
        }

        // Load tests for dropdowns
        function loadTests() {
            // Show loading state
            const testSelects = document.querySelectorAll('select[id$="-test-id"], select[id="test-id"]');
            testSelects.forEach(select => {
                if (select) {
                    select.innerHTML = '<option value="">Loading tests...</option>';
                }
            });

            fetch(`${API_BASE_URL}/tests`, { timeout: 10000 })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    testSelects.forEach(select => {
                        if (select) {
                            select.innerHTML = '<option value="">Select a test</option>';
                            if (data && Array.isArray(data)) {
                                data.forEach(test => {
                                    const option = document.createElement('option');
                                    option.value = test.test_id;
                                    const testDate = test.date_uploaded ? new Date(test.date_uploaded).toLocaleDateString() : 'Unknown date';
                                    option.textContent = `${test.training_name} (${test.test_type}) - ${testDate}`;
                                    select.appendChild(option);
                                });
                            }
                        }
                    });

                    // Refresh filtered historical analytics when tests are loaded
                    loadFilteredHistoricalAnalytics();
                })
                .catch(error => {
                    console.error('Error loading tests:', error);
                    // Show error message to user
                    testSelects.forEach(select => {
                        if (select) {
                            select.innerHTML = '<option value="">Error loading tests</option>';
                        }
                    });
                    alert('Failed to load tests: ' + error.message);
                });
        }

        // Load trainings for dropdown
        function loadTrainings() {
            try {
                console.log('Loading trainings...');
                // Define predefined training options
                const predefinedTrainings = [
                    'Machine guarding',
                    'Action employee can take',
                    'Orientation to Automobile Electrical and electronics',
                    'Loto',
                    'Advance Excel',
                    'Ppe',
                    'Hira',
                    'safety Standards Rules & Regulations'
                ];

                const trainingSelect = document.getElementById('training-selection');
                console.log('Training select element:', trainingSelect);
                if (trainingSelect) {
                    // We no longer clear existing options since they're now in the HTML
                    // Just fetch existing trainings from API and add any new ones
                    console.log('Fetching existing trainings from API...');
                    fetch(`${API_BASE_URL}/trainings`)
                        .then(response => {
                            if (!response.ok) {
                                console.error('HTTP error fetching trainings:', response.status);
                                return [];
                            }
                            return response.json();
                        })
                        .then(data => {
                            console.log('Received trainings data:', data);
                            if (data && Array.isArray(data)) {
                                // Add unique training names that aren't already in the predefined list
                                data.forEach(training => {
                                    // Check if this training is already in the dropdown
                                    let alreadyExists = false;
                                    for (let i = 0; i < trainingSelect.options.length; i++) {
                                        if (trainingSelect.options[i].value === training) {
                                            alreadyExists = true;
                                            break;
                                        }
                                    }

                                    if (!alreadyExists && !predefinedTrainings.includes(training)) {
                                        try {
                                            const option = document.createElement('option');
                                            option.value = training;
                                            option.textContent = training;
                                            trainingSelect.appendChild(option);
                                        } catch (e) {
                                            console.error('Error adding API training option:', training, e);
                                        }
                                    }
                                });
                            }
                        })
                        .catch(error => {
                            console.error('Error loading trainings from API:', error);
                        });
                } else {
                    console.log('Training select element not found');
                }
            } catch (e) {
                console.error('Error in loadTrainings function:', e);
            }
        }

        // Load faculties for dropdown
        function loadFaculties() {
            try {
                console.log('Loading faculties...');

                // Define predefined faculty options (for upload forms)
                const predefinedFaculties = [
                    'Santosh Ghanwat',
                    'Vijayshree Shirole',
                    'Shital Jagtap',
                    'Diksha Srivastava',
                    'Vipin Solanki',
                    'Shital Jagtaap',
                    'Nitin Bankar',
                    'Yogiraj Suruwase',
                    'Tarun Sahu',
                    'Ganesh Patil',
                    'Vikram Shelar',
                    'Shrikant Patil',
                    'Chandrakant Raskar',
                    'Nitin Kolekar',
                    'Nilam Thorat',
                    'Kishor Oak',
                    'Shivram Masurkar',
                    'Ganesh shelar',
                    'Nilesh Tilak',
                    'Balasaheb Landge',
                    'Mangesh Tonde',
                    'Sudhir Kulkarni',
                    'Ram Kumar',
                    'Hanumant Borade',
                    'Vaibhav karandikar',
                    'Renukadas Rakhe',
                    'Pravin Panse'
                ];

                // Handle upload forms (faculty-name, simultaneous-faculty-name) - show predefined options
                const uploadForms = document.querySelectorAll('select[id$="faculty-name"], select[id="simultaneous-faculty-name"]');
                uploadForms.forEach(select => {
                    // Store the current value if any
                    const currentValue = select.value;

                    // Clear existing options except the first one (placeholder)
                    while (select.options.length > 1) {
                        select.remove(1);
                    }

                    // Add predefined faculty options
                    predefinedFaculties.forEach(faculty => {
                        const option = document.createElement('option');
                        option.value = faculty;
                        option.textContent = faculty;
                        select.appendChild(option);
                    });

                    // Restore the current value if it was set
                    if (currentValue) {
                        select.value = currentValue;
                    }
                });

                // Handle historical analytics forms (filtered-faculty-name) - show only used faculties
                const analyticsForms = document.querySelectorAll('select[id="filtered-faculty-name"]');
                if (analyticsForms.length > 0) {
                    // Clear existing options except the first one (placeholder)
                    analyticsForms.forEach(select => {
                        // Store the current value if any
                        const currentValue = select.value;

                        // Clear existing options except the first one (placeholder)
                        while (select.options.length > 1) {
                            select.remove(1);
                        }

                        // Restore the current value if it was set
                        if (currentValue) {
                            select.value = currentValue;
                        }
                    });

                    // Fetch existing faculties from API (only faculties that have been used in uploads)
                    console.log('Fetching existing faculties from API...');
                    fetch(`${API_BASE_URL}/faculties`)
                        .then(response => {
                            if (!response.ok) {
                                console.error('HTTP error fetching faculties:', response.status);
                                return [];
                            }
                            return response.json();
                        })
                        .then(data => {
                            console.log('Received faculties data:', data);
                            if (data && Array.isArray(data)) {
                                // Deduplicate faculty names
                                const uniqueFaculties = [...new Set(data.filter(faculty => faculty && faculty.trim() !== ''))];

                                // Add faculty options to analytics select elements
                                analyticsForms.forEach(select => {
                                    // Add faculty options that have been used in actual uploads
                                    uniqueFaculties.forEach(faculty => {
                                        const option = document.createElement('option');
                                        option.value = faculty;
                                        option.textContent = faculty;
                                        select.appendChild(option);
                                    });
                                });
                            }
                        })
                        .catch(error => {
                            console.error('Error loading faculties from API:', error);
                        });
                }

                // Refresh filtered historical analytics when faculties are loaded
                loadFilteredHistoricalAnalytics();
            } catch (e) {
                console.error('Error in loadFaculties function:', e);
            }
        }



        // Set up event listeners
        function setupEventListeners() {
            // Navigation links
            document.querySelectorAll('.nav-link').forEach(link => {
                if (link) {
                    link.addEventListener('click', function (e) {
                        e.preventDefault();
                        // Remove active class from all nav links
                        document.querySelectorAll('.nav-link').forEach(navLink => {
                            if (navLink) navLink.classList.remove('active');
                        });
                        // Add active class to clicked link
                        this.classList.add('active');
                    });
                }
            });

            // Sidebar links
            document.querySelectorAll('.sidebar-link').forEach(link => {
                if (link) {
                    link.addEventListener('click', function (e) {
                        e.preventDefault();
                        const targetSection = this.getAttribute('data-section');

                        // Remove active class from all sidebar links
                        document.querySelectorAll('.sidebar-link').forEach(sidebarLink => {
                            if (sidebarLink) sidebarLink.classList.remove('active');
                        });

                        // Add active class to clicked link
                        this.classList.add('active');

                        // Hide all sections using CSS class management
                        document.querySelectorAll('.section').forEach(section => {
                            if (section) {
                                section.classList.remove('active');
                                // CRITCAL FIX: Clear inline styles that might have been set by other functions
                                section.style.display = '';
                            }
                        });

                        // Show target section
                        const targetSectionElement = document.getElementById(targetSection);
                        if (targetSectionElement) {
                            targetSectionElement.classList.add('active');
                        }
                    });
                }
            });

            // Add event listener for batch analytics test selection
            const analyticsTestIdElement = document.getElementById('analytics-test-id');
            if (analyticsTestIdElement) {
                analyticsTestIdElement.addEventListener('change', function () {
                    const testId = this.value;
                    if (testId) {
                        getBatchAnalytics(testId);
                    } else {
                        // Hide batch analytics if no test selected
                        const batchAnalyticsResult = document.getElementById('batch-analytics-result');
                        const totalTrainingAnalysis = document.getElementById('total-training-analysis');
                        if (batchAnalyticsResult) {
                            batchAnalyticsResult.classList.remove('active');
                            batchAnalyticsResult.style.display = 'none';
                        }
                        if (totalTrainingAnalysis) {
                            totalTrainingAnalysis.classList.remove('active');
                            totalTrainingAnalysis.style.display = 'none';
                        }
                    }
                });
            }

            // Add event listener for refresh button
            const refreshAnalyticsElement = document.getElementById('refresh-analytics');
            if (refreshAnalyticsElement) {
                refreshAnalyticsElement.addEventListener('click', function () {
                    const analyticsTestIdElement = document.getElementById('analytics-test-id');
                    if (analyticsTestIdElement) {
                        const testId = analyticsTestIdElement.value;
                        if (testId) {
                            getBatchAnalytics(testId);
                        }
                    }
                });
            }

            // Add event listener for add new simultaneous faculty button
            const addNewSimultaneousFacultyBtn = document.getElementById('add-new-simultaneous-faculty-btn');
            if (addNewSimultaneousFacultyBtn) {
                addNewSimultaneousFacultyBtn.addEventListener('click', addNewSimultaneousFaculty);
            }

            // Add event listener for compare tests button
            const compareTestsBtn = document.getElementById('compare-tests-btn');
            if (compareTestsBtn) {
                compareTestsBtn.addEventListener('click', function () {
                    showTestComparisonInterface();
                });
            }
            // Add event listener for refresh dashboard button
            const refreshDashboardBtn = document.getElementById('refresh-dashboard');
            if (refreshDashboardBtn) {
                refreshDashboardBtn.addEventListener('click', function () {
                    try {
                        loadDashboardMetrics();

                        // Load test-specific analytics
                        loadTestSpecificAnalytics();

                        // Load filtered historical analytics
                        loadFilteredHistoricalAnalytics();

                        // Load recent activity
                        loadRecentActivity();
                    } catch (error) {
                        console.error('Error refreshing dashboard:', error);
                        alert('Failed to refresh dashboard: ' + error.message);
                    }
                });
            }



            // Add event listeners for historical analytics
            // Individual analytics options have been removed - only filtered analytics available
            const refreshTrainingListBtn = document.getElementById('refresh-training-list');
            if (refreshTrainingListBtn) {
                refreshTrainingListBtn.addEventListener('click', refreshTrainingList);
            }

            const refreshFacultyListBtn = document.getElementById('refresh-faculty-list');
            if (refreshFacultyListBtn) {
                refreshFacultyListBtn.addEventListener('click', loadFaculties);
            }

            // Filtered analytics
            const loadFilteredAnalyticsBtn = document.getElementById('load-filtered-analytics');
            console.log('Load filtered analytics button:', loadFilteredAnalyticsBtn);
            if (loadFilteredAnalyticsBtn) {
                loadFilteredAnalyticsBtn.addEventListener('click', function () {
                    console.log('Apply Filters button clicked, loading filtered analytics');
                    loadFilteredHistoricalAnalytics();
                });
            } else {
                console.log('Could not find Apply Filters button');
            }

            const clearFiltersBtn = document.getElementById('clear-filters');
            console.log('Clear filters button:', clearFiltersBtn);
            if (clearFiltersBtn) {
                clearFiltersBtn.addEventListener('click', function () {
                    console.log('Clear filters button clicked');
                    clearFilters();
                });
            } else {
                console.log('Could not find Clear filters button');
            }

            // Add event listener for Enter key on date inputs
            const startDateInput = document.getElementById('filtered-start-date');
            const endDateInput = document.getElementById('filtered-end-date');
            const facultySelect = document.getElementById('filtered-faculty-name');
            const trainingSelect = document.getElementById('filtered-training-name');

            if (startDateInput) {
                startDateInput.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') {
                        loadFilteredHistoricalAnalytics();
                    }
                });
            }

            if (endDateInput) {
                endDateInput.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') {
                        loadFilteredHistoricalAnalytics();
                    }
                });
            }

            // Add change event listeners for select elements
            if (facultySelect) {
                facultySelect.addEventListener('change', function () {
                    console.log('Faculty select changed, loading filtered analytics');
                    loadFilteredHistoricalAnalytics();
                });
                // Also listen for Enter key
                facultySelect.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') {
                        console.log('Faculty select Enter key pressed, loading filtered analytics');
                        loadFilteredHistoricalAnalytics();
                    }
                });
            }

            if (trainingSelect) {
                trainingSelect.addEventListener('change', function () {
                    console.log('Training select changed, loading filtered analytics');
                    loadFilteredHistoricalAnalytics();
                });
                // Also listen for Enter key
                trainingSelect.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') {
                        console.log('Training select Enter key pressed, loading filtered analytics');
                        loadFilteredHistoricalAnalytics();
                    }
                });
            }

            // Add change event listeners for date inputs
            if (startDateInput) {
                startDateInput.addEventListener('change', loadFilteredHistoricalAnalytics);
            }

            if (endDateInput) {
                endDateInput.addEventListener('change', loadFilteredHistoricalAnalytics);
            }

            // Add change event listener for ticket no input
            const ticketNoInput = document.getElementById('filtered-ticket-no');
            console.log('Ticket no input element:', ticketNoInput);
            if (ticketNoInput) {
                ticketNoInput.addEventListener('input', function () {
                    console.log('Ticket no input changed');
                    // Debounce the call to avoid too many requests
                    clearTimeout(window.filteredTicketNoDebounceTimer);
                    window.filteredTicketNoDebounceTimer = setTimeout(function () {
                        console.log('Loading filtered analytics after debounce');
                        loadFilteredHistoricalAnalytics();
                    }, 500);
                });
            } else {
                console.log('Could not find ticket no input element');
            }

            // Simultaneous upload functionality
            const uploadSimultaneousBtn = document.getElementById('upload-simultaneous-btn');
            if (uploadSimultaneousBtn) {
                uploadSimultaneousBtn.addEventListener('click', handleSimultaneousUpload);

                // Add input event listener for simultaneous ticket no field to refresh filtered analytics
                const simultaneousTicketNoInput = document.getElementById('simultaneous-ticket-no');
                if (simultaneousTicketNoInput) {
                    simultaneousTicketNoInput.addEventListener('input', function () {
                        // Debounce the call to avoid too many requests
                        clearTimeout(window.simultaneousTicketNoDebounceTimer);
                        window.simultaneousTicketNoDebounceTimer = setTimeout(loadFilteredHistoricalAnalytics, 500);
                    });
                }
            }

            const addSimultaneousTrainingBtn = document.getElementById('add-simultaneous-training-btn');
            if (addSimultaneousTrainingBtn) {
                addSimultaneousTrainingBtn.addEventListener('click', addSimultaneousTraining);
            }

            // Initialize training lists
            refreshTrainingList();

            // Load faculties
            loadFaculties();

            // Upload form
            const uploadForm = document.getElementById('upload-form');
            if (uploadForm) {
                uploadForm.addEventListener('submit', function (e) {
                    try {
                        e.preventDefault();
                        console.log('Upload form submitted');
                        handleUpload();
                    } catch (error) {
                        console.error('Error in upload form submission:', error);
                        alert('An error occurred while uploading files. Please try again.');
                    }
                });

                // Add input event listener for ticket no field to refresh filtered analytics
                const ticketNoInput = document.getElementById('ticket-no');
                if (ticketNoInput) {
                    ticketNoInput.addEventListener('input', function () {
                        // Debounce the call to avoid too many requests
                        clearTimeout(window.ticketNoDebounceTimer);
                        window.ticketNoDebounceTimer = setTimeout(loadFilteredHistoricalAnalytics, 500);
                    });
                }
            }



            // Get candidate analytics
            const getCandidateAnalyticsBtn = document.getElementById('get-candidate-analytics');
            if (getCandidateAnalyticsBtn) {
                getCandidateAnalyticsBtn.addEventListener('click', function () {
                    const candidateIdElement = document.getElementById('candidate-id');
                    if (candidateIdElement) {
                        const candidateId = candidateIdElement.value;
                        if (candidateId) {
                            getCandidateAnalytics(candidateId);
                        }
                    }
                });
            }

            // Generate batch report
            const generateBatchReportBtn = document.getElementById('generate-batch-report');
            if (generateBatchReportBtn) {
                generateBatchReportBtn.addEventListener('click', function () {
                    const reportTestIdElement = document.getElementById('report-test-id');
                    if (reportTestIdElement) {
                        const testId = reportTestIdElement.value;
                        if (testId) {
                            generateBatchReport(testId, 'pdf');
                        }
                    }
                });
            }

            // Download batch Excel
            const downloadBatchExcelBtn = document.getElementById('download-batch-excel');
            if (downloadBatchExcelBtn) {
                downloadBatchExcelBtn.addEventListener('click', function () {
                    const reportTestIdElement = document.getElementById('report-test-id');
                    if (reportTestIdElement) {
                        const testId = reportTestIdElement.value;
                        if (testId) {
                            generateBatchReport(testId, 'excel');
                        }
                    }
                });
            }

            // Generate individual report
            const generateIndividualReportBtn = document.getElementById('generate-individual-report');
            if (generateIndividualReportBtn) {
                generateIndividualReportBtn.addEventListener('click', function () {
                    const individualCandidateIdElement = document.getElementById('individual-candidate-id');
                    if (individualCandidateIdElement) {
                        const candidateId = individualCandidateIdElement.value;
                        if (candidateId) {
                            generateIndividualReport(candidateId, 'pdf');
                        }
                    }
                });
            }

            // Download individual Excel
            const downloadIndividualExcelBtn = document.getElementById('download-individual-excel');
            if (downloadIndividualExcelBtn) {
                downloadIndividualExcelBtn.addEventListener('click', function () {
                    const individualCandidateIdElement = document.getElementById('individual-candidate-id');
                    if (individualCandidateIdElement) {
                        const candidateId = individualCandidateIdElement.value;
                        if (candidateId) {
                            generateIndividualReport(candidateId, 'excel');
                        }
                    }
                });
            }

            // Add new training button
            const addNewTrainingBtn = document.getElementById('add-new-training-btn');
            if (addNewTrainingBtn) {
                addNewTrainingBtn.addEventListener('click', function () {
                    const newTrainingInput = document.getElementById('new-training-input');
                    const trainingSelect = document.getElementById('training-selection');

                    if (newTrainingInput && trainingSelect) {
                        // Toggle visibility of the new training input
                        if (newTrainingInput.style.display === 'none') {
                            newTrainingInput.style.display = 'block';
                        } else {
                            // If input is visible, add the new training to the dropdown
                            const newTrainingNameInput = document.getElementById('new-training-name');
                            if (newTrainingNameInput && newTrainingNameInput.value.trim() !== '') {
                                const newTrainingName = newTrainingNameInput.value.trim();

                                // Check if this training already exists
                                let trainingExists = false;
                                for (let i = 0; i < trainingSelect.options.length; i++) {
                                    if (trainingSelect.options[i].value === newTrainingName) {
                                        trainingExists = true;
                                        break;
                                    }
                                }

                                if (!trainingExists) {
                                    // Add new option to the dropdown
                                    const option = document.createElement('option');
                                    option.value = newTrainingName;
                                    option.textContent = newTrainingName;
                                    trainingSelect.appendChild(option);

                                    // Select the new option
                                    trainingSelect.value = newTrainingName;
                                }

                                // Clear and hide the input
                                newTrainingNameInput.value = '';
                                newTrainingInput.style.display = 'none';
                            } else {
                                // Just hide the input if no value entered
                                newTrainingInput.style.display = 'none';
                            }
                        }
                    }
                });
            }

            // Add new faculty button
            const addNewFacultyBtn = document.getElementById('add-new-faculty-btn');
            if (addNewFacultyBtn) {
                addNewFacultyBtn.addEventListener('click', function () {
                    const newFacultyInput = document.getElementById('new-faculty-input');
                    const facultySelect = document.getElementById('faculty-name');

                    if (newFacultyInput && facultySelect) {
                        // Toggle visibility of the new faculty input
                        if (newFacultyInput.style.display === 'none') {
                            newFacultyInput.style.display = 'block';
                        } else {
                            // If input is visible, add the new faculty to the dropdown
                            const newFacultyNameInput = document.getElementById('new-faculty-name');
                            if (newFacultyNameInput && newFacultyNameInput.value.trim() !== '') {
                                const newFacultyName = newFacultyNameInput.value.trim();

                                // Check if this faculty already exists
                                let facultyExists = false;
                                for (let i = 0; i < facultySelect.options.length; i++) {
                                    if (facultySelect.options[i].value === newFacultyName) {
                                        facultyExists = true;
                                        break;
                                    }
                                }

                                if (!facultyExists) {
                                    // Add new option to the dropdown
                                    const option = document.createElement('option');
                                    option.value = newFacultyName;
                                    option.textContent = newFacultyName;
                                    facultySelect.appendChild(option);

                                    // Select the new option
                                    facultySelect.value = newFacultyName;
                                }

                                // Clear and hide the input
                                newFacultyNameInput.value = '';
                                newFacultyInput.style.display = 'none';

                                // Refresh faculties in all dropdowns
                                loadFaculties();
                            } else {
                                // Just hide the input if no value entered
                                newFacultyInput.style.display = 'none';
                            }
                        }
                    }
                });
            }
        }

        // Individual historical analytics functions have been removed
        // Only filtered analytics is available now

        // Update UI with historical analytics data
        // Update UI with historical analytics data
        function updateHistoricalAnalyticsUI(data) {
            console.log('Updating historical analytics UI with data:', data);

            // Show the results section
            const resultsSection = document.getElementById('historical-analytics-results');
            if (resultsSection) {
                resultsSection.style.display = 'block';
            }

            // Update title
            const titleElement = document.getElementById('historical-results-title');
            if (titleElement) {
                if (data.filters_applied) {
                    let title = 'Filtered Historical Analytics Results';
                    const filters = [];
                    if (data.filters_applied.training_name) {
                        filters.push(`Training: ${data.filters_applied.training_name}`);
                    }
                    if (data.filters_applied.faculty_name) {
                        filters.push(`Faculty: ${data.filters_applied.faculty_name}`);
                    }
                    if (data.filters_applied.ticket_no && data.filters_applied.ticket_no !== '') {
                        filters.push(`Ticket No: ${data.filters_applied.ticket_no}`);
                    }
                    if (data.filters_applied.date_range && data.filters_applied.date_range.start_date) {
                        filters.push(`Date Range: ${data.filters_applied.date_range.start_date} to ${data.filters_applied.date_range.end_date}`);
                    }
                    if (filters.length > 0) {
                        title += ` (${filters.join(', ')})`;
                    }
                    titleElement.textContent = title;
                } else if (data.training_name) {
                    titleElement.textContent = `Historical Analytics Results for ${data.training_name}`;
                } else if (data.date_range) {
                    titleElement.textContent = `Historical Analytics Results for ${data.date_range.start_date} to ${data.date_range.end_date}`;
                } else if (data.name) {
                    titleElement.textContent = `Historical Analytics Results for Faculty: ${data.name}`;
                } else {
                    titleElement.textContent = 'Historical Analytics Results';
                }
            }

            // Update overview section with better error handling
            try {
                const trainingNameElement = document.getElementById('historical-training-name');
                if (trainingNameElement) {
                    if (data.filters_applied && data.filters_applied.training_name) {
                        trainingNameElement.textContent = data.filters_applied.training_name;
                    } else if (data.training_name) {
                        trainingNameElement.textContent = data.training_name;
                    } else if (data.name) {
                        trainingNameElement.textContent = data.name;
                    } else {
                        trainingNameElement.textContent = 'Multiple Trainings';
                    }
                }

                const totalTestsElement = document.getElementById('historical-total-tests');
                if (totalTestsElement) {
                    totalTestsElement.textContent = data.overall_stats.total_tests || 0;
                }

                const totalCandidatesElement = document.getElementById('historical-total-candidates');
                if (totalCandidatesElement) {
                    totalCandidatesElement.textContent = data.overall_stats.total_candidates || 0;
                }

                // Update performance metrics
                const avgScoreElement = document.getElementById('historical-avg-score');
                if (avgScoreElement) {
                    avgScoreElement.textContent =
                        data.overall_stats.average_score ? data.overall_stats.average_score.toFixed(2) + '%' : '0%';
                }

                const passRateElement = document.getElementById('historical-pass-rate');
                if (passRateElement) {
                    passRateElement.textContent =
                        data.overall_stats.pass_rate ? data.overall_stats.pass_rate.toFixed(1) + '%' : '0%';
                }

                const highestScoreElement = document.getElementById('historical-highest-score');
                if (highestScoreElement) {
                    highestScoreElement.textContent =
                        data.overall_stats.highest_score ? data.overall_stats.highest_score.toFixed(1) + '%' : '0%';
                }

                // Update performance distribution
                const total = data.overall_stats.total_candidates || 1;
                const excellent = data.performance_distribution.excellent || 0;
                const good = data.performance_distribution.good || 0;
                const average = data.performance_distribution.average || 0;
                const poor = data.performance_distribution.poor || 0;

                const excellentPercent = (excellent / total) * 100;
                const goodPercent = (good / total) * 100;
                const averagePercent = (average / total) * 100;
                const poorPercent = (poor / total) * 100;

                // Update progress bars
                const excellentProgress = document.getElementById('historical-excellent-progress');
                if (excellentProgress) excellentProgress.style.width = excellentPercent + '%';

                const goodProgress = document.getElementById('historical-good-progress');
                if (goodProgress) goodProgress.style.width = goodPercent + '%';

                const averageProgress = document.getElementById('historical-average-progress');
                if (averageProgress) averageProgress.style.width = averagePercent + '%';

                const poorProgress = document.getElementById('historical-poor-progress');
                if (poorProgress) poorProgress.style.width = poorPercent + '%';

                // Update progress bar counts
                const excellentCount = document.getElementById('historical-excellent-count');
                if (excellentCount) excellentCount.textContent = `${excellent} employees`;

                const goodCount = document.getElementById('historical-good-count');
                if (goodCount) goodCount.textContent = `${good} employees`;

                const averageCount = document.getElementById('historical-average-count');
                if (averageCount) averageCount.textContent = `${average} employees`;

                const poorCount = document.getElementById('historical-poor-count');
                if (poorCount) poorCount.textContent = `${poor} employees`;

                // Update test history table
                const testHistoryBody = document.getElementById('historical-test-history');
                if (testHistoryBody && data.test_history) {
                    testHistoryBody.innerHTML = '';

                    if (data.test_history.length > 0) {
                        data.test_history.forEach(test => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${test.test_id || 'N/A'}</td>
                                <td>${test.test_type || 'N/A'}</td>
                                <td>${test.date_uploaded ? new Date(test.date_uploaded).toLocaleDateString() : 'N/A'}</td>
                                <td>${test.total_candidates || 0}</td>
                            `;
                            testHistoryBody.appendChild(row);
                        });
                    } else {
                        const row = document.createElement('tr');
                        row.innerHTML = '<td colspan="4" class="text-center">No test history available</td>';
                        testHistoryBody.appendChild(row);
                    }
                }
            } catch (uiError) {
                console.error('Error updating UI elements:', uiError);
                // Show error message to user
                if (titleElement) {
                    titleElement.textContent = 'Error displaying analytics data';
                }
            }
        }

        // Refresh training list for historical analytics
        function refreshTrainingList() {
            const filteredTrainingSelect = document.getElementById('filtered-training-name');
            const simultaneousTrainingSelect = document.getElementById('simultaneous-training-name');

            // Define predefined training options
            const predefinedTrainings = [
                "Machine guarding",
                "Action employee can take",
                "Orientation to Automobile Electrical and electronics",
                "Loto",
                "Advance Excel",
                "Ppe",
                "Hira",
                "safety Standards Rules & Regulations"
            ];

            // Add predefined options to all selects first
            if (filteredTrainingSelect) {
                // Clear existing options
                filteredTrainingSelect.innerHTML = '<option value="">All Trainings</option>';
                // Add predefined options
                predefinedTrainings.forEach(training => {
                    const option = document.createElement('option');
                    option.value = training;
                    option.textContent = training;
                    filteredTrainingSelect.appendChild(option);
                });
            }

            if (simultaneousTrainingSelect) {
                // Clear existing options
                simultaneousTrainingSelect.innerHTML = '<option value="">Select existing training or add new</option>';
                // Add predefined options
                predefinedTrainings.forEach(training => {
                    const option = document.createElement('option');
                    option.value = training;
                    option.textContent = training;
                    simultaneousTrainingSelect.appendChild(option);
                });
            }

            // Fetch dynamic training options from API
            fetch(`${API_BASE_URL}/trainings`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // Add dynamic training options (avoid duplicates)
                    if (data && Array.isArray(data)) {
                        data.forEach(training => {
                            // Skip if this training is already in predefined list
                            if (predefinedTrainings.includes(training)) {
                                return;
                            }

                            if (filteredTrainingSelect) {
                                const option = document.createElement('option');
                                option.value = training;
                                option.textContent = training;
                                filteredTrainingSelect.appendChild(option);
                            }

                            if (simultaneousTrainingSelect) {
                                const option = document.createElement('option');
                                option.value = training;
                                option.textContent = training;
                                simultaneousTrainingSelect.appendChild(option);
                            }
                        });
                    }
                })
                .catch(error => {
                    console.error('Error refreshing training list:', error);
                    // Even if API fails, we still have the predefined options
                });

            // Also refresh faculties
            loadFaculties();

            // Refresh filtered historical analytics
            loadFilteredHistoricalAnalytics();
        }

        // Load filtered historical analytics
        function loadFilteredHistoricalAnalytics() {
            console.log('loadFilteredHistoricalAnalytics called');
            const trainingName = document.getElementById('filtered-training-name').value;
            const facultyName = document.getElementById('filtered-faculty-name').value;
            const startDate = document.getElementById('filtered-start-date').value;
            const endDate = document.getElementById('filtered-end-date').value;
            const ticketNo = document.getElementById('filtered-ticket-no').value;
            console.log('Filters:', { trainingName, facultyName, startDate, endDate, ticketNo });

            // Log which specific filter triggered the call (for debugging)
            const callerStack = new Error().stack;
            console.log('Caller stack:', callerStack.split('\n')[2]);

            // Show loading indicator
            const resultsSection = document.getElementById('historical-analytics-results');
            if (resultsSection) {
                resultsSection.style.display = 'block';
                // Add loading text
                const titleElement = document.getElementById('historical-results-title');
                if (titleElement) {
                    titleElement.textContent = 'Loading filtered analytics...';
                }
            }

            // Build query parameters
            const params = new URLSearchParams();
            if (trainingName) params.append('training_name', trainingName);
            if (facultyName) params.append('faculty_name', facultyName);
            if (startDate) params.append('start_date', startDate);
            if (endDate) params.append('end_date', endDate);
            if (ticketNo) params.append('ticket_no', ticketNo);

            fetch(`${API_BASE_URL}/analytics/historical/filtered?${params.toString()}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }

                    // Update UI with filtered historical analytics data
                    updateHistoricalAnalyticsUI(data);
                })
                .catch(error => {
                    console.error('Error loading filtered historical analytics:', error);
                    alert('Failed to load filtered historical analytics: ' + error.message);

                    // Hide results section on error
                    const resultsSection = document.getElementById('historical-analytics-results');
                    if (resultsSection) {
                        resultsSection.style.display = 'none';
                    }
                });
        }

        // Clear filters
        function clearFilters() {
            document.getElementById('filtered-training-name').value = '';
            document.getElementById('filtered-faculty-name').value = '';
            document.getElementById('filtered-start-date').value = '';
            document.getElementById('filtered-end-date').value = '';
            document.getElementById('filtered-ticket-no').value = '';

            // Reload filtered historical analytics with cleared filters
            loadFilteredHistoricalAnalytics();
        }



        // Handle file upload
        function handleUpload() {
            try {
                const testTypeElement = document.getElementById('test-type');
                const trainingDateElement = document.getElementById('training-date');
                const trainingSelectionElement = document.getElementById('training-selection');
                const facultyNameElement = document.getElementById('faculty-name');
                const filesElement = document.getElementById('test-files');

                if (!testTypeElement || !trainingDateElement || !trainingSelectionElement || !filesElement) {
                    console.error('Required form elements not found');
                    alert('Form elements not found. Please refresh the page.');
                    return;
                }

                const testType = testTypeElement.value;
                const trainingDate = trainingDateElement.value;
                const trainingName = trainingSelectionElement.value;

                // Get ticket no if provided
                const ticketNoElement = document.getElementById('ticket-no');
                const ticketNo = ticketNoElement ? ticketNoElement.value.trim() : '';

                // Handle faculty name - check if it's a select or input
                let facultyName = '';
                if (facultyNameElement) {
                    if (facultyNameElement.tagName === 'SELECT') {
                        facultyName = facultyNameElement.value;
                    } else {
                        facultyName = facultyNameElement.value;
                    }
                }
                const files = filesElement.files;

                console.log('Upload triggered with:', { testType, trainingName, files }); // Debug log

                // Check if user wants to add a new training
                if (trainingName === '') {
                    // Check if there's a new training name entered
                    const newTrainingInput = document.getElementById('new-training-name');
                    if (newTrainingInput && newTrainingInput.value.trim() !== '') {
                        // Use the new training name
                        const newTrainingName = newTrainingInput.value.trim();
                        console.log('Using new training name:', newTrainingName);

                        // Add it to the dropdown and select it
                        let optionExists = false;
                        for (let i = 0; i < trainingSelectionElement.options.length; i++) {
                            if (trainingSelectionElement.options[i].value === newTrainingName) {
                                optionExists = true;
                                break;
                            }
                        }

                        if (!optionExists) {
                            const option = document.createElement('option');
                            option.value = newTrainingName;
                            option.textContent = newTrainingName;
                            trainingSelectionElement.appendChild(option);
                        }

                        // Select the new option
                        trainingSelectionElement.value = newTrainingName;

                        // Clear the new training input
                        newTrainingInput.value = '';

                        // Hide the new training input
                        const newTrainingInputDiv = document.getElementById('new-training-input');
                        if (newTrainingInputDiv) {
                            newTrainingInputDiv.style.display = 'none';
                        }
                    }
                }

                const finalTrainingName = trainingSelectionElement.value;

                console.log('Final values:', { testType, trainingDate, finalTrainingName, facultyName, files }); // Debug log

                if (!testType || !trainingDate || !finalTrainingName || files.length === 0) {
                    alert('Please fill in all fields and select files to upload.');
                    return;
                }

                const formData = new FormData();
                for (let i = 0; i < files.length; i++) {
                    formData.append('files', files[i]);
                    console.log('Appending file:', files[i].name); // Debug log
                }
                formData.append('test_type', testType);
                formData.append('training_date', trainingDate);
                formData.append('training_name', finalTrainingName);
                formData.append('faculty_name', facultyName);
                if (ticketNo) {
                    formData.append('ticket_no', ticketNo);
                }
                formData.append('user_id', 1); // Default user ID

                console.log('FormData prepared:', formData); // Debug log

                const uploadBtn = document.getElementById('upload-btn');
                const originalText = uploadBtn ? uploadBtn.innerHTML : '<i class="fas fa-upload me-1"></i>Upload Files';
                if (uploadBtn) {
                    uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Uploading...';
                    uploadBtn.disabled = true;
                }

                console.log('Sending request to:', `${API_BASE_URL}/upload`); // Debug log

                fetch(`${API_BASE_URL}/upload`, {
                    method: 'POST',
                    body: formData
                })
                    .then(response => {
                        console.log('Response received:', response.status, response.statusText); // Debug log
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Success data:', data); // Debug log

                        // Show upload result
                        const uploadResultElement = document.getElementById('upload-result');
                        const uploadMessageElement = document.getElementById('upload-message');
                        const uploadedFilesElement = document.getElementById('uploaded-files');

                        if (uploadResultElement) uploadResultElement.style.display = 'block';
                        if (uploadMessageElement) uploadMessageElement.textContent = data.message || 'Upload completed';
                        if (uploadedFilesElement && data.files) uploadedFilesElement.textContent = data.files.join(', ');

                        // Display Excel analysis if data is available
                        if (data.extracted_data && data.extracted_data.length > 0) {
                            displayExcelAnalysis(data.extracted_data[0]);
                        }

                        // Reset form
                        const uploadFormElement = document.getElementById('upload-form');
                        if (uploadFormElement) uploadFormElement.reset();

                        // Reload tests
                        loadTests();

                        // Reload filtered historical analytics
                        loadFilteredHistoricalAnalytics();
                    })
                    .catch(error => {
                        console.error('Error:', error); // Debug log

                        // Show error in UI
                        const uploadResultElement = document.getElementById('upload-result');
                        const uploadMessageElement = document.getElementById('upload-message');

                        if (uploadResultElement) {
                            uploadResultElement.style.display = 'block';
                            uploadResultElement.className = 'mt-3 alert alert-danger';
                        }
                        if (uploadMessageElement) {
                            uploadMessageElement.textContent = 'Upload failed: ' + error.message;
                        }

                        alert('Upload failed: ' + error.message);
                    })
                    .finally(() => {
                        if (uploadBtn) {
                            uploadBtn.innerHTML = originalText;
                            uploadBtn.disabled = false;
                        }
                    });
            } catch (error) {
                console.error('Error in handleUpload function:', error);
                alert('An unexpected error occurred: ' + error.message);
            }
        }

        // Handle simultaneous upload of pre-test and post-test files
        function handleSimultaneousUpload() {
            try {
                const preTestFilesElement = document.getElementById('pre-test-files');
                const postTestFilesElement = document.getElementById('post-test-files');
                const trainingNameElement = document.getElementById('simultaneous-training-name');
                const facultyNameElement = document.getElementById('simultaneous-faculty-name');
                const preTestDateElement = document.getElementById('pre-test-date');
                const postTestDateElement = document.getElementById('post-test-date');
                const ticketNoElement = document.getElementById('simultaneous-ticket-no');

                if (!preTestFilesElement || !postTestFilesElement || !trainingNameElement || !preTestDateElement || !postTestDateElement) {
                    console.error('Required form elements not found');
                    alert('Form elements not found. Please refresh the page.');
                    return;
                }

                const preTestFiles = preTestFilesElement.files;
                const postTestFiles = postTestFilesElement.files;
                const trainingName = trainingNameElement.value || document.getElementById('new-simultaneous-training-name').value;

                // Handle faculty name - check if it's a select or input
                let facultyName = '';
                if (facultyNameElement) {
                    if (facultyNameElement.tagName === 'SELECT') {
                        facultyName = facultyNameElement.value;
                    } else {
                        facultyName = facultyNameElement.value;
                    }
                }
                const preTestDate = preTestDateElement.value;
                const postTestDate = postTestDateElement.value;
                const ticketNo = ticketNoElement ? ticketNoElement.value.trim() : '';

                if ((!preTestFiles || preTestFiles.length === 0) && (!postTestFiles || postTestFiles.length === 0)) {
                    alert('Please select at least one pre-test file or one post-test file.');
                    return;
                }

                if (!trainingName) {
                    alert('Please select or enter a training name.');
                    return;
                }

                if (!preTestDate && !postTestDate) {
                    alert('Please enter at least one test date.');
                    return;
                }

                // Upload pre-test files if available
                if (preTestFiles && preTestFiles.length > 0) {
                    uploadTestFiles(preTestFiles, 'Pre-Test', trainingName, facultyName, preTestDate, ticketNo);
                }

                // Upload post-test files if available
                if (postTestFiles && postTestFiles.length > 0) {
                    uploadTestFiles(postTestFiles, 'Post-Test', trainingName, facultyName, postTestDate, ticketNo);
                }

                // Show success message
                alert('Files uploaded successfully!');

                // Reset form
                preTestFilesElement.value = '';
                postTestFilesElement.value = '';
                trainingNameElement.value = '';
                if (facultyNameElement) facultyNameElement.value = '';
                preTestDateElement.value = '';
                postTestDateElement.value = '';
                document.getElementById('new-simultaneous-training-name').value = '';

                // Reload tests
                loadTests();
            } catch (error) {
                console.error('Error in handleSimultaneousUpload function:', error);
                alert('An unexpected error occurred: ' + error.message);
            }
        }

        // Upload test files function (helper for simultaneous upload)
        function uploadTestFiles(files, testType, trainingName, facultyName, trainingDate, ticketNo = '') {
            const formData = new FormData();
            for (let i = 0; i < files.length; i++) {
                formData.append('files', files[i]);
            }
            formData.append('test_type', testType);
            formData.append('training_date', trainingDate);
            formData.append('training_name', trainingName);
            formData.append('faculty_name', facultyName);
            if (ticketNo) {
                formData.append('ticket_no', ticketNo);
            }
            formData.append('user_id', 1); // Default user ID

            return fetch(`${API_BASE_URL}/upload`, {
                method: 'POST',
                body: formData
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log(`${testType} upload successful:`, data);
                    return data;
                })
                .catch(error => {
                    console.error(`Error uploading ${testType}:`, error);
                    throw error;
                });
        }

        // Add simultaneous training
        function addSimultaneousTraining() {
            const newTrainingInput = document.getElementById('new-simultaneous-training-name');
            const trainingSelect = document.getElementById('simultaneous-training-name');

            if (newTrainingInput && trainingSelect && newTrainingInput.value.trim() !== '') {
                const newTrainingName = newTrainingInput.value.trim();

                // Check if this training already exists
                let trainingExists = false;
                for (let i = 0; i < trainingSelect.options.length; i++) {
                    if (trainingSelect.options[i].value === newTrainingName) {
                        trainingExists = true;
                        break;
                    }
                }

                if (!trainingExists) {
                    // Add new option to the dropdown
                    const option = document.createElement('option');
                    option.value = newTrainingName;
                    option.textContent = newTrainingName;
                    trainingSelect.appendChild(option);

                    // Select the new option
                    trainingSelect.value = newTrainingName;
                }

                // Clear the input
                newTrainingInput.value = '';
            }
        }

        // Add new simultaneous faculty
        function addNewSimultaneousFaculty() {
            const newFacultyInput = document.getElementById('new-simultaneous-faculty-input');
            const facultySelect = document.getElementById('simultaneous-faculty-name');

            if (newFacultyInput && facultySelect) {
                // Toggle visibility of the new faculty input
                if (newFacultyInput.style.display === 'none') {
                    newFacultyInput.style.display = 'block';
                } else {
                    // If input is visible, add the new faculty to the dropdown
                    const newFacultyNameInput = document.getElementById('new-simultaneous-faculty-name');
                    if (newFacultyNameInput && newFacultyNameInput.value.trim() !== '') {
                        const newFacultyName = newFacultyNameInput.value.trim();

                        // Check if this faculty already exists
                        let facultyExists = false;
                        for (let i = 0; i < facultySelect.options.length; i++) {
                            if (facultySelect.options[i].value === newFacultyName) {
                                facultyExists = true;
                                break;
                            }
                        }

                        if (!facultyExists) {
                            // Add new option to the dropdown
                            const option = document.createElement('option');
                            option.value = newFacultyName;
                            option.textContent = newFacultyName;
                            facultySelect.appendChild(option);

                            // Select the new option
                            facultySelect.value = newFacultyName;
                        }

                        // Clear and hide the input
                        newFacultyNameInput.value = '';
                        newFacultyInput.style.display = 'none';

                        // Refresh faculties in all dropdowns
                        loadFaculties();
                    } else {
                        // Just hide the input if no value entered
                        newFacultyInput.style.display = 'none';
                    }
                }
            }
        }

        // Display Excel analysis
        function displayExcelAnalysis(extractedData) {
            console.log('Displaying analysis for:', extractedData);

            // Validate input
            if (!extractedData) {
                console.error('No extracted data provided');
                return;
            }

            // Show the analysis section
            const excelAnalysisElement = document.getElementById('excel-analysis');
            if (excelAnalysisElement) {
                excelAnalysisElement.style.display = 'block';
            }

            // Populate file information
            const fileInfo = document.getElementById('file-info');
            if (fileInfo) {
                fileInfo.innerHTML = '';
                if (extractedData.filename) {
                    fileInfo.innerHTML += `<li><strong>File Name:</strong> ${extractedData.filename}</li>`;
                }
                if (extractedData.test_id) {
                    fileInfo.innerHTML += `<li><strong>Test ID:</strong> ${extractedData.test_id}</li>`;
                }
            }

            // Populate data summary
            const dataSummary = document.getElementById('data-summary');
            if (dataSummary) {
                dataSummary.innerHTML = '';

                // Check if we have extracted data
                if (extractedData.extracted) {
                    const extracted = extractedData.extracted;

                    // Display message if available
                    if (extracted.message) {
                        dataSummary.innerHTML += `<li><strong>Message:</strong> ${extracted.message}</li>`;
                    }

                    // Display total employees if available
                    if (extracted.total_candidates !== undefined) {
                        dataSummary.innerHTML += `<li><strong>Total Employees:</strong> ${extracted.total_candidates}</li>`;
                    }

                    // All files are treated uniformly
                    dataSummary.innerHTML += `<li><strong>File Type:</strong> Test Data</li>`;
                    // Display columns if available
                    if (extracted.columns) {
                        dataSummary.innerHTML += `<li><strong>Columns:</strong> ${extracted.columns.length}</li>`;
                        dataSummary.innerHTML += `<li><strong>Column Names:</strong> ${extracted.columns.slice(0, 5).join(', ')}${extracted.columns.length > 5 ? '...' : ''}</li>`;
                    }

                    // Display file type if available
                    if (extracted.file_type) {
                        dataSummary.innerHTML += `<li><strong>Detected Type:</strong> ${extracted.file_type}</li>`;
                    }
                }
            }

            // Populate candidate table
            const tableHead = document.getElementById('candidate-table-head');
            const tableBody = document.getElementById('candidate-table-body');
            if (tableHead) tableHead.innerHTML = '';
            if (tableBody) tableBody.innerHTML = '';

            // Populate subject performance
            const subjectPerformance = document.getElementById('subject-performance');
            if (subjectPerformance) subjectPerformance.innerHTML = '';

            // If we have full candidate data (not just summary), display it
            if (extractedData.full_data && extractedData.full_data.candidates && extractedData.full_data.candidates.length > 0) {
                const candidates = extractedData.full_data.candidates;

                // Create table headers (uniform for all test files)
                if (tableHead) {
                    let headerRow = '<tr><th>#</th><th>Name</th><th>Ticket No</th>';
                    if (candidates.length > 0 && candidates[0].marks) {
                        const subjects = Object.keys(candidates[0].marks);
                        subjects.forEach(subject => {
                            headerRow += `<th>${subject}</th>`;
                        });
                    }
                    headerRow += '</tr>';
                    tableHead.innerHTML = headerRow;
                }

                // Create table rows (show first 10 candidates)
                const displayCandidates = candidates.slice(0, 10);
                if (tableBody) {
                    displayCandidates.forEach((candidate, index) => {
                        let row = `<tr><td>${index + 1}</td><td>${candidate.name || 'N/A'}</td><td>${candidate.ticket_no || 'N/A'}</td>`;
                        if (candidate.marks) {
                            const subjects = Object.keys(candidate.marks);
                            subjects.forEach(subject => {
                                row += `<td>${candidate.marks[subject] || 0}</td>`;
                            });
                        }
                        row += '</tr>';
                        tableBody.innerHTML += row;
                    });
                }

                // Add note if there are more candidates
                if (tableBody && candidates.length > 10) {
                    const colCount = 2 + (Object.keys(candidates[0].marks || {}).length || 0);
                    tableBody.innerHTML += `<tr><td colspan="${colCount}" class="text-center">Showing 10 of ${candidates.length} employees</td></tr>`;
                }

                // Populate subject performance (uniform for all test files)
                if (candidates.length > 0 && candidates[0].marks) {
                    // For regular files, show subject-wise performance
                    const subjects = Object.keys(candidates[0].marks);

                    if (subjectPerformance) {
                        subjects.forEach(subject => {
                            // Calculate statistics for this subject
                            const scores = candidates.map(candidate => candidate.marks[subject] || 0);
                            const average = (scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(2);
                            const highest = Math.max(...scores);
                            const lowest = Math.min(...scores);

                            const card = `
                                <div class="col-md-6 col-lg-3 mb-3">
                                    <div class="card card-custom">
                                        <div class="card-body text-center">
                                            <h6>${subject}</h6>
                                            <div class="metric-value">${average}</div>
                                            <div class="d-flex justify-content-between mt-2">
                                                <small>Highest: ${highest}</small>
                                                <small>Lowest: ${lowest}</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                            subjectPerformance.innerHTML += card;
                        });
                    }
                }
            } else {
                // If we don't have full candidate data, show a message
                if (tableBody) {
                    tableBody.innerHTML = '<tr><td colspan="10" class="text-center">No employee data available for display</td></tr>';
                }

                if (subjectPerformance) {
                    subjectPerformance.innerHTML = '<div class="col-12"><div class="alert alert-info text-center">No subject performance data available</div></div>';
                }
            }
        }



        // Get candidate analytics
        function getCandidateAnalytics(candidateId) {
            fetch(`${API_BASE_URL}/analytics/candidate/${candidateId}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('candidate-analytics-result').style.display = 'block';
                    document.getElementById('candidate-id-display').textContent = data.candidate_id;
                    document.getElementById('improvement-percentage').textContent = data.improvement_percentage ? data.improvement_percentage.toFixed(2) + '%' : '0%';

                    const performanceList = document.getElementById('performance-list');
                    performanceList.innerHTML = '';

                    if (data.performance_history && data.performance_history.length > 0) {
                        data.performance_history.forEach(record => {
                            const li = document.createElement('li');
                            li.textContent = `${record.test_type}: ${record.score} (${record.percentage ? record.percentage.toFixed(1) : 'N/A'}%)`;
                            performanceList.appendChild(li);
                        });
                    } else {
                        const li = document.createElement('li');
                        li.textContent = 'No performance history available';
                        performanceList.appendChild(li);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to get employee analytics: ' + error.message);
                });
        }

        // Generate batch report
        function generateBatchReport(testId, format) {
            const url = `${API_BASE_URL}/reports/batch/${testId}?format=${format}`;
            window.open(url, '_blank');
        }

        // Generate individual report
        function generateIndividualReport(candidateId, format) {
            const url = `${API_BASE_URL}/reports/candidate/${candidateId}?format=${format}`;
            window.open(url, '_blank');
        }

        // Sync attendance
        function syncAttendance() {
            const syncBtn = document.getElementById('sync-attendance');
            const originalText = syncBtn.innerHTML;
            syncBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Syncing...';
            syncBtn.disabled = true;

            fetch(`${API_BASE_URL}/onedrive/attendance`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('attendance-sync-result').style.display = 'block';
                    document.getElementById('attendance-records-count').textContent = data.sample_data ? data.sample_data.length : 0;
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to sync attendance: ' + error.message);
                })
                .finally(() => {
                    syncBtn.innerHTML = originalText;
                    syncBtn.disabled = false;
                });
        }

        // Sync documents
        function syncDocuments() {
            const syncBtn = document.getElementById('sync-documents');
            const originalText = syncBtn.innerHTML;
            syncBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Syncing...';
            syncBtn.disabled = true;

            fetch(`${API_BASE_URL}/onedrive/documents`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('documents-sync-result').style.display = 'block';
                    document.getElementById('documents-count').textContent = data.documents ? data.documents.length : 0;
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to sync documents: ' + error.message);
                })
                .finally(() => {
                    syncBtn.innerHTML = originalText;
                    syncBtn.disabled = false;
                });
        }

        // Show test comparison interface
        function showTestComparisonInterface() {
            // Hide all sections using the existing system
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
                section.style.display = '';
            });

            // Create or show comparison section
            let comparisonSection = document.getElementById('comparison-section');
            if (!comparisonSection) {
                // Create the comparison section
                const mainContent = document.querySelector('.col-lg-10.col-md-9.p-4');
                comparisonSection = document.createElement('div');
                comparisonSection.id = 'comparison-section';
                comparisonSection.className = 'section active';
                comparisonSection.innerHTML = `
                    <h2 class="mb-4">Test Comparison Analysis</h2>
                    
                    <!-- Back Button -->
                    <div class="mb-3">
                        <button class="btn btn-secondary" onclick="showMainDashboard()">
                            <i class="fas fa-arrow-left me-1"></i>Back to Dashboard
                        </button>
                    </div>
                    
                    <!-- Comparison Controls -->
                    <div class="card card-custom mb-4">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0"><i class="fas fa-exchange-alt me-2"></i>Select Tests to Compare</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-5">
                                    <label for="pre-test-select" class="form-label">Pre-Test</label>
                                    <select class="form-select" id="pre-test-select">
                                        <option value="">Select Pre-Test</option>
                                    </select>
                                </div>
                                <div class="col-md-5">
                                    <label for="post-test-select" class="form-label">Post-Test</label>
                                    <select class="form-select" id="post-test-select">
                                        <option value="">Select Post-Test</option>
                                    </select>
                                </div>
                                <div class="col-md-2 d-flex align-items-end">
                                    <button class="btn btn-success w-100" id="perform-comparison-btn">
                                        <i class="fas fa-calculator me-1"></i>Compare
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Comparison Results -->
                    <div id="comparison-results" style="display: none;">
                        <!-- Attendance Analysis -->
                        <div class="card card-custom mb-4">
                            <div class="card-header bg-info text-white">
                                <h5 class="mb-0"><i class="fas fa-users me-2"></i>Attendance Analysis</h5>
                            </div>
                            <div class="card-body">
                                <div class="row text-center">
                                    <div class="col-md-4 mb-3">
                                        <div class="card card-custom h-100">
                                            <div class="card-body">
                                                <h3 id="both-tests-count">0</h3>
                                                <p class="mb-0">Attended Both Tests</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <div class="card card-custom h-100">
                                            <div class="card-body">
                                                <h3 id="pre-only-count">0</h3>
                                                <p class="mb-0">Pre-Test Only</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <div class="card card-custom h-100">
                                            <div class="card-body">
                                                <h3 id="post-only-count">0</h3>
                                                <p class="mb-0">Post-Test Only</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Training Effectiveness -->
                        <div class="card card-custom mb-4">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Training Effectiveness</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3 mb-3">
                                        <div class="card card-custom h-100">
                                            <div class="card-body">
                                                <h3 id="avg-improvement">0%</h3>
                                                <p class="mb-0">Avg Improvement</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <div class="card card-custom h-100 border-success">
                                            <div class="card-body">
                                                <h3 id="positive-improvement" class="text-success">0</h3>
                                                <p class="mb-0">Positive Improvement</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <div class="card card-custom h-100 border-danger">
                                            <div class="card-body">
                                                <h3 id="negative-improvement" class="text-danger">0</h3>
                                                <p class="mb-0">Negative/No Improvement</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <div class="card card-custom h-100">
                                            <div class="card-body">
                                                <h3 id="effectiveness-index">0</h3>
                                                <p class="mb-0">Effectiveness Index</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-12">
                                        <div style="height: 300px;">
                                            <canvas id="improvement-chart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Top Improvers -->
                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <div class="card card-custom h-100">
                                    <div class="card-header bg-primary text-white">
                                        <h5 class="mb-0"><i class="fas fa-trophy me-2"></i>Top Improvers</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="table-responsive">
                                            <table class="table table-hover">
                                                <thead>
                                                    <tr>
                                                        <th>ID</th>
                                                        <th>Pre (%)</th>
                                                        <th>Post (%)</th>
                                                        <th>Gain</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="top-improvers-body"></tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-4">
                                <div class="card card-custom h-100">
                                    <div class="card-header bg-warning text-dark">
                                        <h5 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Learning Gaps</h5>
                                    </div>
                                    <div class="card-body">
                                        <p>Candidates with post-test scores lower than pre-test scores.</p>
                                        <div class="table-responsive">
                                            <table class="table table-hover">
                                                <thead>
                                                    <tr>
                                                        <th>ID</th>
                                                        <th>Pre (%)</th>
                                                        <th>Post (%)</th>
                                                        <th>Loss</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="learning-gaps-body"></tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                mainContent.appendChild(comparisonSection);

                // Set up comparison button listener
                document.getElementById('perform-comparison-btn').addEventListener('click', performTestComparison);

                // Load tests for selects
                loadTestsForComparison();
            } else {
                comparisonSection.style.display = 'block';
                comparisonSection.classList.add('active');
                loadTestsForComparison();
            }
        }

        // Function to show main dashboard (helper to go back)
        function showMainDashboard() {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
                section.style.display = ''; // Clear inline style
            });
            document.getElementById('dashboard-section').classList.add('active');
            // document.getElementById('dashboard-section').style.display = 'block'; // Rely on class

            document.querySelectorAll('.sidebar-link').forEach(link => {
                if (link.getAttribute('data-section') === 'dashboard-section') {
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            });
        }

        // Load tests for comparison selects
        function loadTestsForComparison() {
            fetch(`${API_BASE_URL}/tests`)
                .then(response => response.json())
                .then(data => {
                    const preSelect = document.getElementById('pre-test-select');
                    const postSelect = document.getElementById('post-test-select');

                    if (!preSelect || !postSelect) return;

                    preSelect.innerHTML = '<option value="">Select Pre-Test</option>';
                    postSelect.innerHTML = '<option value="">Select Post-Test</option>';

                    data.forEach(test => {
                        const option = `<option value="${test.test_id}">${test.training_name} (${test.test_type}) - ${new Date(test.date_uploaded).toLocaleDateString()}</option>`;
                        preSelect.innerHTML += option;
                        postSelect.innerHTML += option;
                    });
                });
        }

        // Perform test comparison
        function performTestComparison() {
            const preTestId = document.getElementById('pre-test-select').value;
            const postTestId = document.getElementById('post-test-select').value;

            if (!preTestId || !postTestId) {
                alert('Please select both a pre-test and a post-test.');
                return;
            }

            // Show loading state
            const btn = document.getElementById('perform-comparison-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Calculating...';
            btn.disabled = true;

            fetch(`${API_BASE_URL}/analytics/compare?pre_test_id=${preTestId}&post_test_id=${postTestId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(data.error);
                        return;
                    }

                    // Show results div
                    document.getElementById('comparison-results').style.display = 'block';

                    // Update Attendance
                    document.getElementById('both-tests-count').textContent = data.attendance.both_tests;
                    document.getElementById('pre-only-count').textContent = data.attendance.pre_only.length;
                    document.getElementById('post-only-count').textContent = data.attendance.post_only.length;

                    // Update Effectiveness
                    document.getElementById('avg-improvement').textContent = data.effectiveness.average_improvement.toFixed(1) + '%';
                    document.getElementById('positive-improvement').textContent = data.effectiveness.positive_improvements;
                    document.getElementById('negative-improvement').textContent = data.effectiveness.negative_improvements;
                    document.getElementById('effectiveness-index').textContent = data.effectiveness.effectiveness_index.toFixed(2);

                    // Update Improvers table
                    const improversBody = document.getElementById('top-improvers-body');
                    improversBody.innerHTML = '';
                    data.improvers.top_10.forEach(p => {
                        improversBody.innerHTML += `
                            <tr>
                                <td>${p.candidate_id}</td>
                                <td>${p.pre_score.toFixed(1)}%</td>
                                <td>${p.post_score.toFixed(1)}%</td>
                                <td class="text-success">+${p.improvement.toFixed(1)}%</td>
                            </tr>
                        `;
                    });

                    // Update Gaps table
                    const gapsBody = document.getElementById('learning-gaps-body');
                    gapsBody.innerHTML = '';
                    data.improvers.declined.forEach(p => {
                        gapsBody.innerHTML += `
                            <tr>
                                <td>${p.candidate_id}</td>
                                <td>${p.pre_score.toFixed(1)}%</td>
                                <td>${p.post_score.toFixed(1)}%</td>
                                <td class="text-danger">${p.improvement.toFixed(1)}%</td>
                            </tr>
                        `;
                    });

                    // Update Chart
                    initializeComparisonCharts(data.effectiveness.improvement_bins);
                })
                .catch(error => console.error('Error:', error))
                .finally(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                });
        }

        let comparisonChart = null;
        function initializeComparisonCharts(bins) {
            const ctx = document.getElementById('improvement-chart').getContext('2d');
            if (comparisonChart) comparisonChart.destroy();

            comparisonChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['<0%', '0-10%', '10-25%', '25-50%', '>50%'],
                    datasets: [{
                        label: 'Number of Employees',
                        data: [
                            bins['negative'],
                            bins['low'],
                            bins['medium'],
                            bins['high'],
                            bins['significant']
                        ],
                        backgroundColor: ['#dc3545', '#ffc107', '#17a2b8', '#007bff', '#28a745']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        // Get Batch Analytics
        function getBatchAnalytics(testId) {
            fetch(`${API_BASE_URL}/analytics/batch/${testId}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('batch-analytics-result').style.display = 'block';
                    document.getElementById('batch-total-candidates').textContent = data.batch_stats.total_candidates;
                    document.getElementById('batch-avg-score').textContent = data.batch_stats.average_percentage.toFixed(2) + '%';
                    document.getElementById('batch-pass-rate').textContent = data.batch_stats.pass_rate.toFixed(1) + '%';

                    updateScoreDistributionChart(data.performance_distribution);
                })
                .catch(error => console.error('Error:', error));
        }

        let batchDistChart = null;
        function updateScoreDistributionChart(dist) {
            const ctx = document.getElementById('score-distribution-chart').getContext('2d');
            if (batchDistChart) batchDistChart.destroy();

            batchDistChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Excellent', 'Good', 'Average', 'Poor'],
                    datasets: [{
                        label: 'Candidates',
                        data: [dist.excellent, dist.good, dist.average, dist.poor],
                        backgroundColor: ['#28a745', '#17a2b8', '#ffc107', '#dc3545']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }



        // Load recent activity
        function loadRecentActivity() {
            fetch(`${API_BASE_URL}/tests`)
                .then(response => response.json())
                .then(data => {
                    const tableBody = document.getElementById('recent-activity-body');
                    if (!tableBody) return;

                    if (!data || data.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="5" class="text-center">No recent activity found</td></tr>';
                        return;
                    }

                    // Sort by date uploaded (descending) - assuming date_uploaded exists, otherwise use date_conducted or ID
                    const sortedTests = data.sort((a, b) => {
                        const dateA = a.date_uploaded ? new Date(a.date_uploaded) : new Date(0);
                        const dateB = b.date_uploaded ? new Date(b.date_uploaded) : new Date(0);
                        return dateB - dateA;
                    });

                    // Take recent 5
                    const recentTests = sortedTests.slice(0, 5);

                    // Clear existing
                    tableBody.innerHTML = '';

                    // Populate
                    recentTests.forEach(test => {
                        const row = document.createElement('tr');
                        const dateStr = test.date_uploaded ? new Date(test.date_uploaded).toLocaleDateString() : 'N/A';
                        const statusBadge = test.status === 'completed' ?
                            '<span class="badge bg-success">Completed</span>' :
                            (test.status === 'failed' ? '<span class="badge bg-danger">Failed</span>' :
                                '<span class="badge bg-warning text-dark">' + (test.status || 'Pending') + '</span>');

                        row.innerHTML = `
                            <td>${test.training_name || 'Total Training Analysis'}</td>
                            <td>${dateStr}</td>
                            <td>${test.test_type}</td>
                            <td class="avg-score-cell"><div class="spinner-border spinner-border-sm text-primary" role="status"></div></td>
                            <td>${statusBadge}</td>
                        `;
                        tableBody.appendChild(row);

                        // Fetch score
                        fetch(`${API_BASE_URL}/analytics/batch/${test.test_id}`)
                            .then(res => res.json())
                            .then(analytics => {
                                const cell = row.querySelector('.avg-score-cell');
                                if (cell) {
                                    const score = analytics.batch_stats?.average_percentage !== undefined ?
                                        analytics.batch_stats.average_percentage.toFixed(1) + '%' : 'N/A';
                                    cell.textContent = score;
                                }
                            })
                            .catch(err => {
                                const cell = row.querySelector('.avg-score-cell');
                                if (cell) cell.textContent = 'N/A';
                            });
                    });
                })
                .catch(error => {
                    console.error('Error loading recent activity:', error);
                    const tableBody = document.getElementById('recent-activity-body');
                    if (tableBody) {
                        tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Error loading data</td></tr>';
                    }
                });
        }

        // Load dashboard metrics
        function loadDashboardMetrics() {
            // Load summary stats from /analytics/overall
            fetch(`${API_BASE_URL}/analytics/overall`)
                .then(response => response.json())
                .then(data => {
                    if (data.overall_stats) {
                        document.getElementById('total-tests-count').textContent = data.overall_stats.total_tests || 0;
                        document.getElementById('total-candidates-dashboard').textContent = data.overall_stats.total_candidates || 0;
                        document.getElementById('avg-score-dashboard').textContent = (data.overall_stats.average_score || 0).toFixed(1) + '%';
                        document.getElementById('pass-rate-dashboard').textContent = (data.overall_stats.pass_rate || 0).toFixed(1) + '%';

                        // Update timestamp
                        const timestampElement = document.getElementById('update-timestamp');
                        if (timestampElement) {
                            timestampElement.textContent = new Date().toLocaleString();
                        }

                        // Update Pass/Fail Chart
                        if (passFailChart) {
                            passFailChart.data.datasets[0].data = [
                                data.overall_stats.passed_candidates || 0,
                                data.overall_stats.failed_candidates || 0
                            ];
                            passFailChart.update();
                        }

                        // Update progress bars on dashboard
                        const total = data.overall_stats.total_candidates || 1;
                        if (data.performance_distribution) {
                            const dist = data.performance_distribution;

                            const excellentPercent = ((dist.excellent || 0) / total) * 100;
                            const goodPercent = ((dist.good || 0) / total) * 100;
                            const averagePercent = ((dist.average || 0) / total) * 100;
                            const poorPercent = ((dist.poor || 0) / total) * 100;

                            const ep = document.getElementById('excellent-progress-dashboard');
                            if (ep) ep.style.width = excellentPercent + '%';

                            const gp = document.getElementById('good-progress-dashboard');
                            if (gp) gp.style.width = goodPercent + '%';

                            const ap = document.getElementById('average-progress-dashboard');
                            if (ap) ap.style.width = averagePercent + '%';

                            const pp = document.getElementById('poor-progress-dashboard');
                            if (pp) pp.style.width = poorPercent + '%';

                            // Update counts if elements exist
                            ['excellent', 'good', 'average', 'poor'].forEach(key => {
                                const el = document.getElementById(`${key}-count-dashboard`);
                                if (el) el.textContent = `${dist[key] || 0} employees`;
                            });
                        }
                    }

                    if (data.performance_distribution && scoreDistributionChartDashboard) {
                        // Update Distribution Chart
                        scoreDistributionChartDashboard.data.datasets[0].data = [
                            data.performance_distribution.excellent || 0,
                            data.performance_distribution.good || 0,
                            data.performance_distribution.average || 0,
                            data.performance_distribution.poor || 0
                        ];
                        scoreDistributionChartDashboard.update();
                    }
                })
                .catch(error => console.error('Error loading overall analytics:', error));

            // Load trends
            fetch(`${API_BASE_URL}/analytics/trends`)
                .then(response => response.json())
                .then(data => {
                    if (data.labels && performanceChart) {
                        performanceChart.data.labels = data.labels;
                        performanceChart.data.datasets[0].data = data.pre_test_avg;
                        performanceChart.data.datasets[1].data = data.post_test_avg;
                        performanceChart.update();
                    }
                })
                .catch(error => console.error('Error loading trends:', error));

            // Load top performers
            fetch(`${API_BASE_URL}/analytics/performers?sort=top&limit=10`)
                .then(response => response.json())
                .then(data => {
                    if (Array.isArray(data) && topPerformersChart) {
                        topPerformersChart.data.labels = data.map(p => p.candidate_id);
                        topPerformersChart.data.datasets[0].data = data.map(p => p.max_score);
                        topPerformersChart.update();
                    }
                })
                .catch(error => console.error('Error loading top performers:', error));

            // Load bottom performers
            fetch(`${API_BASE_URL}/analytics/performers?sort=bottom&limit=10`)
                .then(response => response.json())
                .then(data => {
                    if (Array.isArray(data) && bottomPerformersChart) {
                        bottomPerformersChart.data.labels = data.map(p => p.candidate_id);
                        bottomPerformersChart.data.datasets[0].data = data.map(p => p.max_score);
                        bottomPerformersChart.update();
                    }
                })
                .catch(error => console.error('Error loading bottom performers:', error));

            // Load pre-test vs post-test comparison
            fetch(`${API_BASE_URL}/analytics/training-comparison`)
                .then(response => response.json())
                .then(data => {
                    if (data.labels && prePostComparisonChart) {
                        prePostComparisonChart.data.labels = data.labels;
                        prePostComparisonChart.data.datasets[0].data = data.pre_test_avgs;
                        prePostComparisonChart.data.datasets[1].data = data.post_test_avgs;
                        prePostComparisonChart.update();
                    }
                })
                .catch(error => console.error('Error loading training comparison:', error));
        }


        // Load test-specific analytics
        function loadTestSpecificAnalytics() {
            fetch(`${API_BASE_URL}/tests`)
                .then(response => response.json())
                .then(data => {
                    const tableBody = document.getElementById('test-analytics-body');
                    if (!tableBody) return;

                    if (!data || data.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="8" class="text-center">No tests found</td></tr>';
                        return;
                    }

                    // Clear existing content
                    tableBody.innerHTML = '';

                    // Process each test
                    data.forEach(test => {
                        // Create a row for each test
                        const row = document.createElement('tr');

                        // Format date
                        const uploadDate = test.date_uploaded ? new Date(test.date_uploaded).toLocaleDateString() : 'N/A';

                        // We'll need to get analytics for each test separately
                        fetch(`${API_BASE_URL}/analytics/batch/${test.test_id}`)
                            .then(res => res.json())
                            .then(analytics => {
                                // Extract analytics data
                                const totalCandidates = analytics.batch_stats?.total_candidates || 0;
                                const avgScore = analytics.batch_stats?.average_percentage ?
                                    analytics.batch_stats.average_percentage.toFixed(2) + '%' : 'N/A';
                                const passRate = analytics.batch_stats?.pass_rate ?
                                    analytics.batch_stats.pass_rate.toFixed(1) + '%' : 'N/A';

                                row.innerHTML = `
                                    <td>${test.test_id}</td>
                                    <td>${test.training_name || 'N/A'}</td>
                                    <td>${test.test_type || 'N/A'}</td>
                                    <td>${uploadDate}</td>
                                    <td>${totalCandidates}</td>
                                    <td>${avgScore}</td>
                                    <td>${passRate}</td>
                                    <td>
                                        <button class="btn btn-sm btn-primary view-details" data-test-id="${test.test_id}">
                                            <i class="fas fa-eye"></i> View
                                        </button>
                                    </td>
                                `;

                                // Add event listener for view details button
                                const viewButton = row.querySelector('.view-details');
                                if (viewButton) {
                                    viewButton.addEventListener('click', () => {
                                        // Switch to analytics section and load this test
                                        document.querySelectorAll('.sidebar-link').forEach(link => {
                                            if (link.getAttribute('data-section') === 'analytics-section') {
                                                link.click();
                                            }
                                        });

                                        // Set the test in the dropdown and trigger change
                                        const testSelect = document.getElementById('analytics-test-id');
                                        if (testSelect) {
                                            testSelect.value = test.test_id;
                                            // Trigger change event
                                            testSelect.dispatchEvent(new Event('change'));
                                        }
                                    });
                                }

                                tableBody.appendChild(row);
                            })
                            .catch(error => {
                                console.error('Error fetching analytics for test:', test.test_id, error);
                                row.innerHTML = `
                                    <td>${test.test_id}</td>
                                    <td>${test.training_name || 'N/A'}</td>
                                    <td>${test.test_type || 'N/A'}</td>
                                    <td>${uploadDate}</td>
                                    <td colspan="4" class="text-center text-danger">Error loading analytics</td>
                                `;
                                tableBody.appendChild(row);
                            });
                    });
                })
                .catch(error => {
                    console.error('Error loading tests:', error);
                    const tableBody = document.getElementById('test-analytics-body');
                    if (tableBody) {
                        tableBody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Error loading tests: ' + error.message + '</td></tr>';
                    }
                });
        }

        // Delete all Excel data
        function deleteAllExcelData() {
            if (!confirm('Are you sure you want to delete ALL Excel data? This action cannot be undone.')) {
                return;
            }

            const deleteBtn = document.getElementById('delete-all-data');
            const originalText = deleteBtn.innerHTML;
            deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Deleting...';
            deleteBtn.disabled = true;

            fetch(`${API_BASE_URL}/data/delete_all`, {
                method: 'DELETE'
            })
                .then(response => response.json())
                .then(data => {
                    const deleteResult = document.getElementById('delete-result');
                    const deleteMessage = document.getElementById('delete-message');

                    deleteResult.style.display = 'block';
                    deleteResult.className = 'mt-3 alert alert-success';
                    deleteMessage.textContent = data.message || 'All data deleted successfully';

                    // Reload dashboard metrics
                    loadDashboardMetrics();

                    // Reload filtered historical analytics
                    loadFilteredHistoricalAnalytics();
                })
                .catch(error => {
                    console.error('Error:', error);

                    const deleteResult = document.getElementById('delete-result');
                    const deleteMessage = document.getElementById('delete-message');

                    deleteResult.style.display = 'block';
                    deleteResult.className = 'mt-3 alert alert-danger';
                    deleteMessage.textContent = 'Delete failed: ' + error.message;

                    alert('Delete failed: ' + error.message);
                })
                .finally(() => {
                    deleteBtn.innerHTML = originalText;
                    deleteBtn.disabled = false;
                });
        }

        // DOM Loaded Event
        document.addEventListener('DOMContentLoaded', function () {
            console.log('DOM Content Loaded - Initializing...');
            // Initialize everything
            initializeCharts();
            loadTests();
            loadTrainings();
            refreshTrainingList();
            loadDashboardMetrics();
            setupEventListeners();
            loadFaculties();

            // Load test-specific analytics
            loadTestSpecificAnalytics();

            // Load initial filtered historical analytics
            loadFilteredHistoricalAnalytics();

            // Load recent activity
            loadRecentActivity();

            console.log('DOM Content Loaded - Initialization complete');

            // Manual test to ensure training options are added
            setTimeout(function () {
                const trainingSelect = document.getElementById('training-selection');
                if (trainingSelect) {
                    // Check if predefined trainings are already there
                    const predefinedTrainings = [
                        'Machine guarding',
                        'Action employee can take',
                        'Orientation to Automobile Electrical and electronics',
                        'Loto',
                        'Advance Excel',
                        'Ppe',
                        'Hira',
                        'safety Standards Rules & Regulations'
                    ];

                    // Count how many of our predefined trainings are already in the dropdown
                    let foundCount = 0;
                    for (let i = 0; i < trainingSelect.options.length; i++) {
                        if (predefinedTrainings.includes(trainingSelect.options[i].textContent)) {
                            foundCount++;
                        }
                    }

                    // If we're missing most of our predefined trainings, something went wrong
                    if (foundCount < predefinedTrainings.length) {
                        console.log(' Predefined training options missing, re-adding them...');
                        // Add missing predefined training options
                        predefinedTrainings.forEach(training => {
                            // Check if this training already exists
                            let alreadyExists = false;
                            for (let i = 0; i < trainingSelect.options.length; i++) {
                                if (trainingSelect.options[i].textContent === training) {
                                    alreadyExists = true;
                                    break;
                                }
                            }

                            if (!alreadyExists) {
                                const option = document.createElement('option');
                                option.value = training;
                                option.textContent = training;
                                trainingSelect.appendChild(option);
                            }
                        });
                        console.log('Manual training options re-added');
                    } else {
                        console.log(' Predefined training options are present');
                    }
                } else {
                    console.log(' Training select element not found for manual addition');
                }
            }, 1500);
        });
    </script>
</body>

</html>